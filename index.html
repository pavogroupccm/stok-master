<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pavo Group | Y√∂netim Paneli</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --secondary: #64748b; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9;
            --bg: #f8fafc; --card-bg: #ffffff; --text-main: #1e293b; --border: #e2e8f0; --input-bg: #f1f5f9; 
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
            --border: #334155; --input-bg: #334155; --secondary: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; transition: 0.3s; height: 100vh; overflow: hidden; }

        /* LOGIN SCREEN STYLES */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .login-logo { width: 180px; margin-bottom: 20px; filter: invert(0); }
        [data-theme="dark"] .login-logo { filter: invert(1); }
        .login-input { margin-bottom: 15px; padding: 12px; width: 100%; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; }
        
        /* APP LAYOUT */
        #app-screen { display: none; height: 100vh; width: 100%; }
        .wrapper { display: flex; height: 100%; width: 100%; }
        
        .sidebar { width: 260px; background: #1e293b; height: 100%; color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .brand-logo { width: 100%; max-width: 160px; margin-bottom: 30px; filter: brightness(0) invert(1); }
        .nav-btn { width: 100%; background: transparent; color: #94a3b8; padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; border: none; text-align: left; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn:hover:not(.active) { background: #334155; color: white; }
        .user-info { margin-top: auto; padding-top: 15px; border-top: 1px solid #334155; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 10px; }

        .main-container { flex-grow: 1; overflow-y: auto; padding: 25px; position: relative; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* COMPONENTS */
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        
        /* DASHBOARD SPECIFIC */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .dash-grid { grid-template-columns: 1fr; } }
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* FORMS & TABLES */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; color: var(--secondary); margin-bottom: 5px; font-weight: 600; }
        input, select { background: var(--input-bg); color: var(--text-main); padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; color: var(--secondary); border-bottom: 2px solid var(--border); font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; vertical-align: top; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-action { color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; margin-left: 2px; font-size: 0.8rem; }
        
        .tag { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
        .tag-ankara { background: #ffedd5; color: #9a3412; }
        .tag-istanbul { background: #e0f2fe; color: #075985; }
        
        .money { color: var(--success); font-weight: bold; display: block; margin-top: 2px;}
        .cost-detail { font-size: 0.75rem; color: var(--secondary); display: block; margin-bottom: 2px; border-bottom: 1px dashed var(--border); padding-bottom: 2px;}
        .fair-warning { background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .expense-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        
        /* DETAY MODAL STƒ∞LLERƒ∞ (YENƒ∞) */
        .detail-group { background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); font-size: 0.9rem; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row span:first-child { color: var(--secondary); font-weight: 500; }
        .detail-row span:last-child { font-weight: 600; color: var(--text-main); }
        .detail-row.total { border-top: 2px solid var(--border); border-bottom: none; font-weight: bold; font-size: 1.1rem; margin-top: 10px; padding-top: 15px; color: var(--success); }
        .detail-header { font-size: 1.2rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .detail-sub { color: var(--secondary); font-size: 0.9rem; margin-bottom: 15px; }
    </style>
</head>
<body data-theme="light">

    <div id="login-screen">
        <div class="login-card">
            <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="login-logo">
            <h2 style="margin-bottom: 20px;">Personel Giri≈üi</h2>
            <input type="email" id="email" class="login-input" placeholder="E-posta Adresi">
            <input type="password" id="password" class="login-input" placeholder="≈ûifre">
            <button class="btn btn-primary" onclick="login()">Giri≈ü Yap</button>
            <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-screen">
        <div class="wrapper">
            <div class="sidebar">
                <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="brand-logo">
                
                <button class="nav-btn active" onclick="showPage('dashboard-page', this)">üìä Y√∂netim √ñzeti</button>
                <button class="nav-btn" onclick="showPage('stok-page', this)">üì¶ Stok Y√∂netimi</button>
                <button class="nav-btn" onclick="showPage('fuar-page', this)">üèüÔ∏è Fuar Takibi</button>
                <button class="nav-btn" onclick="showPage('log-page', this)">üïí ƒ∞≈ülem Ge√ßmi≈üi</button>
                
                <div class="user-info" id="user-display"></div>
                <button class="nav-btn" onclick="toggleTheme()" style="font-size: 0.75rem;">üåì Gece/G√ºnd√ºz</button>
                <button class="nav-btn" onclick="logout()" style="color:var(--danger); font-size: 0.75rem;">üö™ √áƒ±kƒ±≈ü Yap</button>
            </div>

            <div class="main-container">

                <div id="dashboard-page" class="page active">
                    <h2 style="margin-bottom:20px;">Ho≈ü Geldiniz, Genel Bakƒ±≈ü</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <small>Toplam Stok Adedi</small>
                            <h2 id="d-totalStock">0</h2>
                        </div>
                        <div class="stat-card">
                            <small>Toplam Fuar Harcamasƒ±</small>
                            <h2 id="d-totalFairCost" style="color:var(--success)">$ 0</h2>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid var(--danger)">
                            <small>Kritik Seviyedeki √úr√ºnler</small>
                            <h2 id="d-criticalStock" style="color:var(--danger)">0</h2>
                        </div>
                    </div>

                    <div class="dash-grid">
                        <div class="card">
                            <h3>Depo Stok Daƒüƒ±lƒ±mƒ±</h3>
                            <div class="chart-container"><canvas id="stockChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3>Fuar B√ºt√ße Daƒüƒ±lƒ±mƒ±</h3>
                            <div class="chart-container"><canvas id="fairChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="stok-page" class="page">
                    <div class="card">
                        <h3>√úr√ºn Giri≈üi</h3>
                        <div class="form-grid">
                            <div>
                                <div class="form-group"><label>√úr√ºn Adƒ±</label><input type="text" id="newName"></div>
                                <div class="form-group"><label>Kategori</label>
                                    <select id="newCat">
                                        <option value="Genel">Se√ßiniz</option>
                                        <option value="Basƒ±lƒ± Malzeme">Basƒ±lƒ± Malzeme</option>
                                        <option value="Promosyon √úr√ºn">Promosyon √úr√ºn</option>
                                        <option value="Sarf Malzeme">Sarf Malzeme</option>
                                        <option value="Demirba≈ülar">Demirba≈ülar</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                 <div class="form-group"><label>Depo</label><select id="newWarehouse"><option value="Ankara">Ankara</option><option value="ƒ∞stanbul">ƒ∞stanbul</option></select></div>
                                 <div style="display: flex; gap: 10px;">
                                     <div class="form-group" style="flex:1"><label>Miktar</label><input type="number" id="newQty"></div>
                                     <div class="form-group" style="flex:1"><label>Limit</label><input type="number" id="newLimit"></div>
                                 </div>
                                 <button class="btn btn-primary" onclick="addNewProduct()" style="margin-top: 5px;">Kaydet</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="searchInput" placeholder="üîç Ara..." onkeyup="updateStokUI()" style="flex:1;">
                            <button class="btn" onclick="setWhFilter('all')" style="background:#ddd">Hepsi</button>
                            <button class="btn" onclick="setWhFilter('Ankara')" style="background:#ddd">Ankara</button>
                            <button class="btn" onclick="setWhFilter('ƒ∞stanbul')" style="background:#ddd">ƒ∞st</button>
                        </div>
                        <table>
                            <thead><tr><th>√úr√ºn</th><th>Depo</th><th>Stok</th><th style="text-align:right">ƒ∞≈ülem</th></tr></thead>
                            <tbody id="inventoryBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="fuar-page" class="page">
                    <div class="card">
                        <h3>Yeni Fuar Planlama</h3>
                        <div class="form-grid">
                            <div>
                                <div class="form-group"><label>Fuar Adƒ±</label><input type="text" id="fName"></div>
                                <div class="form-group"><label>√úlke</label><input type="text" id="fCountry"></div>
                                <div class="form-group"><label>Tarih</label><input type="date" id="fDate"></div>
                            </div>
                            <div>
                                 <div class="form-group"><label>Tedarik√ßi</label><input type="text" id="fSupp"></div>
                                 <div class="form-group"><label>Alan (m¬≤)</label><input type="number" id="fM2"></div>
                                 <div style="display:flex; gap:10px;">
                                     <div class="form-group" style="flex:1"><label>Kira ($)</label><input type="number" id="fRent"></div>
                                     <div class="form-group" style="flex:1"><label>Stant ($)</label><input type="number" id="fConst"></div>
                                 </div>
                                 <button class="btn btn-primary" onclick="addNewFair()" style="margin-top: 10px;">Ekle</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Fuar Listesi</h3>
                        <table>
                            <thead><tr><th>Fuar</th><th>Tarih</th><th>Maliyet</th><th style="text-align:right">ƒ∞≈ülem</th></tr></thead>
                            <tbody id="fairBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="log-page" class="page">
                    <div class="card">
                        <h3>üïí ƒ∞≈ülem Ge√ßmi≈üi</h3>
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table>
                                <thead><tr><th>Tarih</th><th>Kullanƒ±cƒ±</th><th>ƒ∞≈ülem</th><th>Detay</th></tr></thead>
                                <tbody id="logBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>D√ºzenle</h3><button onclick="closeModal('editModal')">X</button></div>
            <input type="hidden" id="editId">
            <div class="form-grid">
                <div><label>Ad</label><input type="text" id="eName"><label>√úlke</label><input type="text" id="eCountry"><label>Tarih</label><input type="date" id="eDate"></div>
                <div><label>m¬≤</label><input type="number" id="eM2"><label>Kira</label><input type="number" id="eRent"><label>Stant</label><input type="number" id="eConst"><label>Tedarik√ßi</label><input type="text" id="eSupp"></div>
            </div>
            <h4>Ekstra Giderler</h4>
            <div id="expenseList"></div>
            <button class="btn btn-sm" onclick="addExpenseRow()" style="margin-top:10px;">+ Gider Ekle</button>
            <button class="btn btn-primary" onclick="saveFairChanges()" style="margin-top:10px; width:100%">Kaydet</button>
        </div>
    </div>

    <div id="viewModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Fuar Kartƒ±</h3>
                <button onclick="closeModal('viewModal')" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úñ</button>
            </div>
            <div id="viewContent"></div>
            <div style="margin-top:15px; text-align:right;"><button class="btn" style="background:#ddd" onclick="closeModal('viewModal')">Kapat</button></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAfvTWPkPVQ63T_fTHiYMRnerHkdgqbTr4",
      authDomain: "stokmasterbulut.firebaseapp.com",
      databaseURL: "https://stokmasterbulut-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "stokmasterbulut",
      storageBucket: "stokmasterbulut.firebasestorage.app",
      messagingSenderId: "623117556073",
      appId: "1:623117556073:web:b082fb0567879ac71d45f8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let inventory = [];
    let fairs = [];
    let logs = [];
    let currentUser = null;
    let whFilter = 'all';
    let chartStock, chartFair;

    // AUTH
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('user-display').innerText = `Kullanƒ±cƒ±: ${user.email}`;
            initDataListeners();
        } else {
            currentUser = null;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
        }
    });

    function login() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(e, p).catch(err => {
            document.getElementById('login-error').innerText = "Hatalƒ± e-posta veya ≈üifre!";
        });
    }

    function logout() { auth.signOut(); }

    function initDataListeners() {
        db.ref('inventory').on('value', snap => { inventory = snap.val() ? Object.values(snap.val()) : []; updateStokUI(); updateDashboard(); });
        db.ref('fairs').on('value', snap => { fairs = snap.val() ? Object.values(snap.val()) : []; updateFuarUI(); updateDashboard(); });
        db.ref('logs').limitToLast(100).on('value', snap => { logs = snap.val() ? Object.values(snap.val()) : []; updateLogUI(); });
    }

    // DASHBOARD
    function updateDashboard() {
        let totalStock = 0, critical = 0;
        let ank = 0, ist = 0;
        inventory.forEach(i => {
            totalStock += i.qty;
            if(i.warehouse === "Ankara") ank += i.qty; else ist += i.qty;
            if(i.qty <= (i.limit || 5)) critical++;
        });

        let totalFairCost = 0;
        let rentSum = 0, constSum = 0, otherSum = 0;
        fairs.forEach(f => {
            let r = parseFloat(f.rent||0), c = parseFloat(f.const||0), o = 0;
            if(f.expenses) f.expenses.forEach(e => o += parseFloat(e.cost||0));
            totalFairCost += (r+c+o);
            rentSum += r; constSum += c; otherSum += o;
        });

        document.getElementById('d-totalStock').innerText = totalStock;
        document.getElementById('d-criticalStock').innerText = critical;
        document.getElementById('d-totalFairCost').innerText = "$ " + totalFairCost.toLocaleString();

        const ctx1 = document.getElementById('stockChart').getContext('2d');
        if(chartStock) chartStock.destroy();
        chartStock = new Chart(ctx1, { type: 'pie', data: { labels: ['Ankara', 'ƒ∞stanbul'], datasets: [{ data: [ank, ist], backgroundColor: ['#f97316', '#0ea5e9'] }] } });

        const ctx2 = document.getElementById('fairChart').getContext('2d');
        if(chartFair) chartFair.destroy();
        chartFair = new Chart(ctx2, { type: 'bar', data: { labels: ['Kira', 'Stant', 'Diƒüer'], datasets: [{ label: 'Maliyet ($)', data: [rentSum, constSum, otherSum], backgroundColor: ['#6366f1', '#10b981', '#f59e0b'] }] } });
    }

    // STOK UI
    function updateStokUI() {
        const s = document.getElementById('searchInput').value.toLowerCase();
        const b = document.getElementById('inventoryBody');
        b.innerHTML = '';
        inventory.forEach(i => {
            const match = (i.name.toLowerCase().includes(s) || i.category.toLowerCase().includes(s)) && (whFilter==='all' || i.warehouse===whFilter);
            if(match) {
                b.innerHTML += `<tr>
                    <td><b>${i.name}</b><br><small>${i.category}</small></td>
                    <td><span class="tag tag-${i.warehouse.toLowerCase()}">${i.warehouse}</span></td>
                    <td style="color:${i.qty <= (i.limit||5)?'red':'inherit'}"><b>${i.qty}</b></td>
                    <td style="text-align:right">
                        <input type="number" id="amt-${i.id}" value="1" style="width:40px">
                        <button class="btn-action" style="background:var(--success)" onclick="changeQty('${i.id}',1)">+</button>
                        <button class="btn-action" style="background:var(--danger)" onclick="handleOut('${i.id}')">-</button>
                        <button class="btn-action" style="background:#8b5cf6" onclick="transfer('${i.id}')">‚áÑ</button>
                        <button class="btn-action" style="background:#64748b" onclick="del('inventory/','${i.id}')">üóëÔ∏è</button>
                    </td></tr>`;
            }
        });
    }

    // FUAR UI
    function updateFuarUI() {
        const b = document.getElementById('fairBody');
        const now = new Date(); const warn = new Date(); warn.setDate(now.getDate()+30);
        b.innerHTML = '';
        fairs.forEach(f => {
            const d = new Date(f.date);
            const isSoon = d >= now && d <= warn;
            let o = 0; if(f.expenses) f.expenses.forEach(e => o += parseFloat(e.cost||0));
            const tot = parseFloat(f.rent||0) + parseFloat(f.const||0) + o;
            
            b.innerHTML += `<tr class="${isSoon ? 'fair-warning':''}">
                <td><b>${f.name}</b><br><small>${f.country}</small></td>
                <td>${f.date} ${isSoon ? '‚ö†Ô∏è' : ''}</td>
                <td><span class="money">$ ${tot.toLocaleString()}</span></td>
                <td style="text-align:right">
                    <button class="btn-action" style="background:var(--info)" onclick="viewFair('${f.id}')">üëÅÔ∏è</button>
                    <button class="btn-action" style="background:#eab308" onclick="editFair('${f.id}')">‚úèÔ∏è</button>
                    <button class="btn-action" style="background:var(--danger)" onclick="del('fairs/','${f.id}')">üóëÔ∏è</button>
                </td></tr>`;
        });
    }

    // AUTH DESTEKLƒ∞ LOG
    function addLog(name, wh, type, amount, info) {
        const userEmail = currentUser ? currentUser.email : "Bilinmeyen";
        db.ref('logs/' + Date.now()).set({ time: new Date().toLocaleString('tr-TR'), user: userEmail, name, wh, type, amount, info });
    }
    
    function updateLogUI() {
        const b = document.getElementById('logBody'); b.innerHTML = '';
        [...logs].reverse().forEach(l => {
            b.innerHTML += `<tr><td><small>${l.time}</small></td><td>${l.user||'-'}</td><td><b style="color:${l.type==='√áƒ±kƒ±≈ü'?'red':'green'}">${l.type}</b></td><td>${l.name} (${l.amount}) - ${l.info}</td></tr>`;
        });
    }

    // ACTIONS
    function changeQty(id, dir) { 
        const i = inventory.find(x => x.id===id); 
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        db.ref('inventory/'+id).update({qty: i.qty+amt});
        addLog(i.name, i.warehouse, "Giri≈ü", amt, "Ekleme");
    }
    function handleOut(id) {
        const i = inventory.find(x => x.id===id);
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        if(i.qty<amt) return alert("Yetersiz");
        const dest = prompt("Nereye?"); if(!dest) return;
        db.ref('inventory/'+id).update({qty: i.qty-amt});
        addLog(i.name, i.warehouse, "√áƒ±kƒ±≈ü", amt, dest);
    }
    function transfer(id) {
        const i = inventory.find(x => x.id===id);
        const target = i.warehouse==="Ankara"?"ƒ∞stanbul":"Ankara";
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        if(i.qty<amt) return alert("Yetersiz");
        db.ref('inventory/'+id).update({qty: i.qty-amt});
        let ti = inventory.find(x => x.name===i.name && x.warehouse===target);
        if(ti) db.ref('inventory/'+ti.id).update({qty: ti.qty+amt});
        else { const nid=Date.now(); db.ref('inventory/'+nid).set({...i, id:nid, warehouse:target, qty:amt}); }
        addLog(i.name, i.warehouse, "Transfer", amt, target);
    }
    function addNewProduct() {
        const id="p_"+Date.now();
        db.ref('inventory/'+id).set({
            id, name: document.getElementById('newName').value, category: document.getElementById('newCat').value,
            warehouse: document.getElementById('newWarehouse').value, qty: parseInt(document.getElementById('newQty').value)||0, limit: parseInt(document.getElementById('newLimit').value)||5
        });
    }
    function addNewFair() {
        const id="f_"+Date.now();
        db.ref('fairs/'+id).set({
            id, name: document.getElementById('fName').value, country: document.getElementById('fCountry').value, date: document.getElementById('fDate').value,
            m2: document.getElementById('fM2').value, supplier: document.getElementById('fSupp').value, rent: document.getElementById('fRent').value, const: document.getElementById('fConst').value
        });
    }

    // DETAYLI G√ñR√úNT√úLEME MODALI
    function viewFair(id) {
        const f = fairs.find(x => x.id===id);
        const rent = parseFloat(f.rent || 0);
        const cons = parseFloat(f.const || 0);
        let otherTotal = 0;
        let expensesHtml = '';

        if(f.expenses && f.expenses.length > 0) {
            expensesHtml = '<div style="margin-top:10px; font-weight:bold; color:var(--secondary); font-size:0.9rem;">Ekstra Giderler</div>';
            f.expenses.forEach(e => {
                otherTotal += parseFloat(e.cost || 0);
                expensesHtml += `<div class="detail-row" style="padding-left:10px;"><span>‚Ä¢ ${e.desc}</span><span>$ ${parseFloat(e.cost).toLocaleString()}</span></div>`;
            });
        } else {
            expensesHtml = '<div style="margin-top:10px; color:#999; font-size:0.8rem; font-style:italic;">Ekstra gider girilmemi≈ü.</div>';
        }

        const grandTotal = rent + cons + otherTotal;

        const html = `
            <div class="detail-header">${f.name}</div>
            <div class="detail-sub">${f.country}</div>
            
            <div class="detail-group">
                <div class="detail-row"><span>üìÖ Tarih:</span><span>${f.date}</span></div>
                <div class="detail-row"><span>üè¢ Tedarik√ßi:</span><span>${f.supplier || '-'}</span></div>
                <div class="detail-row"><span>üìê Alan:</span><span>${f.m2} m¬≤</span></div>
            </div>

            <div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:5px;">Maliyet Tablosu</div>
            <div class="detail-row"><span>Alan Kirasƒ±:</span><span>$ ${rent.toLocaleString()}</span></div>
            <div class="detail-row"><span>Stant Yapƒ±m:</span><span>$ ${cons.toLocaleString()}</span></div>
            ${expensesHtml}
            <div class="detail-row total"><span>GENEL TOPLAM:</span><span>$ ${grandTotal.toLocaleString()}</span></div>
        `;

        document.getElementById('viewContent').innerHTML = html;
        document.getElementById('viewModal').style.display = 'flex';
    }

    // EDIT MODAL
    function editFair(id) {
        const f = fairs.find(x => x.id===id);
        document.getElementById('editId').value = f.id;
        document.getElementById('eName').value = f.name; document.getElementById('eCountry').value = f.country;
        document.getElementById('eDate').value = f.date; document.getElementById('eM2').value = f.m2;
        document.getElementById('eRent').value = f.rent; document.getElementById('eConst').value = f.const;
        document.getElementById('eSupp').value = f.supplier;
        const c = document.getElementById('expenseList'); c.innerHTML='';
        if(f.expenses) f.expenses.forEach(e => addExpenseRow(e.desc, e.cost));
        document.getElementById('editModal').style.display='flex';
    }
    function saveFairChanges() {
        const id=document.getElementById('editId').value;
        const ex=[]; document.querySelectorAll('.expense-row').forEach(r => {
            const d=r.querySelector('.ex-desc').value; const c=r.querySelector('.ex-cost').value;
            if(d&&c) ex.push({desc:d, cost:c});
        });
        db.ref('fairs/'+id).update({
            name: document.getElementById('eName').value, country: document.getElementById('eCountry').value, date: document.getElementById('eDate').value,
            m2: document.getElementById('eM2').value, rent: document.getElementById('eRent').value, const: document.getElementById('eConst').value,
            supplier: document.getElementById('eSupp').value, expenses: ex
        });
        closeModal('editModal');
    }
    function addExpenseRow(d='', c='') {
        const div = document.createElement('div'); div.className='expense-row';
        div.innerHTML=`<input type="text" value="${d}" class="ex-desc" placeholder="Gider"><input type="number" value="${c}" class="ex-cost" placeholder="$" style="width:80px"><button onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('expenseList').appendChild(div);
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function showPage(pid, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(pid).classList.add('active'); btn.classList.add('active');
    }
    function setWhFilter(v) { whFilter=v; updateStokUI(); }
    function del(p,id) { if(confirm('Sil?')) db.ref(p+id).remove(); }
    function toggleTheme() {
        const t = document.body.getAttribute('data-theme')==='dark'?'light':'dark';
        document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t);
    }
    window.onload = () => document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');
</script>
</body>
</html>
