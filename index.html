<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StokMaster | Kategorili Stok Takibi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --secondary: #64748b; --success: #22c55e;
            --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --card-bg: #ffffff; 
            --text-main: #1e293b; --border: #e2e8f0; --input-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
            --border: #334155; --input-bg: #334155; --secondary: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; display: flex; transition: 0.3s; }
        .sidebar { width: 260px; background: #1e293b; height: 100vh; color: white; padding: 20px; position: fixed; box-sizing: border-box; display: flex; flex-direction: column; }
        .sidebar h1 { font-size: 1.4rem; margin-bottom: 30px; color: #818cf8; }
        .sidebar-btn { width: 100%; background: #334155; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: none; text-align: left; font-size: 0.85rem; }
        
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); box-sizing: border-box; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; }
        .full-width { grid-column: span 2; }
        
        /* Geli≈ümi≈ü Input Grubu (Kategori eklendi) */
        .input-group { display: grid; grid-template-columns: 1.2fr 1fr 0.8fr 1fr 0.6fr 0.6fr 0.6fr; gap: 8px; margin-bottom: 15px; }
        input, select { background: var(--input-bg); color: var(--text-main); padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.75rem; width: 100%; box-sizing: border-box; }
        
        .btn-add { background: var(--primary); color: white; cursor: pointer; border:none; border-radius:8px; padding:10px; font-weight:600;}
        .btn-action { color: white; cursor: pointer; border:none; border-radius:6px; padding:6px 10px; font-size: 0.9rem; }
        .btn-transfer { background: #8b5cf6; color: white; cursor: pointer; border:none; border-radius:6px; padding:6px 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; color: var(--secondary); border-bottom: 2px solid var(--border); font-size: 0.75rem; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        
        .tag { padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }
        .tag-ankara { background: #ffedd5; color: #9a3412; }
        .tag-istanbul { background: #e0f2fe; color: #075985; }
        .tag-danger { background: var(--danger); color: white; }
        .tag-cat { background: #f1f5f9; color: #475569; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>üì¶ StokMaster Pro</h1>
    <button class="sidebar-btn" onclick="exportInventoryCSV()">üìä Mevcut Stok (CSV)</button>
    <button class="sidebar-btn" onclick="exportLogsCSV()">üïí Hareket Ge√ßmi≈üi (CSV)</button>
    <button class="sidebar-btn" onclick="toggleTheme()">üåì Gece/G√ºnd√ºz Modu</button>
</div>

<div class="main-content">
    <div class="stats-bar">
        <div class="stat-card">
            <small>Ankara Toplam</small>
            <h2 id="ankaraTotal">0</h2>
        </div>
        <div class="stat-card">
            <small>ƒ∞stanbul Toplam</small>
            <h2 id="istanbulTotal">0</h2>
        </div>
        <div class="stat-card" style="border-color: var(--danger);">
            <small style="color:var(--danger)">Kritik Limit Altƒ±ndakiler</small>
            <h2 id="criticalAlert" style="color:var(--danger)">0</h2>
        </div>
    </div>

    <div class="grid-container">
        <div class="card">
            <h3>√úr√ºn ve Kategori Y√∂netimi</h3>
            <div class="input-group">
                <input type="text" id="newName" placeholder="√úr√ºn Adƒ±">
                <select id="newCat">
                    <option value="Genel">Genel</option>
                    <option value="Basƒ±lƒ± Malzeme">Basƒ±lƒ±/Baskƒ±lƒ±</option>
                    <option value="Promosyon √úr√ºn">Promosyon</option>
                    <option value="Sarf Malzeme">Sarf Malzeme</option>
                    <option value="Demirba≈ülar">Demirba≈ülar</option>
                </select>
                <select id="newWarehouse">
                    <option value="Ankara">Ankara</option>
                    <option value="ƒ∞stanbul">ƒ∞stanbul</option>
                </select>
                <input type="text" id="newSupplier" placeholder="Tedarik√ßi">
                <input type="number" id="newQty" placeholder="Stok">
                <input type="number" id="newLimit" placeholder="Limit" title="Kritik Limit">
                <button class="btn-add" onclick="addNewProduct()">Ekle</button>
            </div>
            
            <input type="text" id="searchInput" placeholder="üîç √úr√ºn, Kategori, Depo veya Tedarik√ßi Ara..." onkeyup="updateUI()" style="width:100%; margin-top:5px; font-size: 0.9rem;">

            <table>
                <thead>
                    <tr><th>√úr√ºn / Kategori</th><th>Depo</th><th>Stok / Limit</th><th style="text-align:right">ƒ∞≈ülemler</th></tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <div>
            <div class="card" style="border-left: 5px solid var(--danger);">
                <h3 style="color:var(--danger); margin-top:0;">‚ö†Ô∏è Acil Tedarik</h3>
                <table id="criticalTable" style="font-size: 0.8rem;">
                    <thead><tr><th>√úr√ºn</th><th>Depo</th><th>Stok</th></tr></thead>
                    <tbody id="criticalBody"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Depo Daƒüƒ±lƒ±mƒ±</h3>
                <canvas id="inventoryChart"></canvas>
            </div>
        </div>

        <div class="card full-width">
            <h3>üïí Hareket ve Transfer Kayƒ±tlarƒ±</h3>
            <div style="max-height: 200px; overflow-y: auto;">
                <table style="font-size: 0.75rem;">
                    <thead>
                        <tr><th>Tarih</th><th>√úr√ºn</th><th>Depo</th><th>ƒ∞≈ülem</th><th>Miktar</th><th>A√ßƒ±klama</th></tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let inventory = JSON.parse(localStorage.getItem('catDepoInv')) || [];
    let logs = JSON.parse(localStorage.getItem('catDepoLogs')) || [];
    let myChart;

    function initChart() {
        const ctx = document.getElementById('inventoryChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'pie',
            data: { labels: ['Ankara', 'ƒ∞stanbul'], datasets: [{ data: [0, 0], backgroundColor: ['#f97316', '#0ea5e9'], borderWidth: 0 }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        if(localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    }

    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    function updateUI() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const body = document.getElementById('inventoryBody');
        const criticalBody = document.getElementById('criticalBody');
        const logBody = document.getElementById('logBody');
        let ankSum = 0, istSum = 0, criticalCount = 0;

        body.innerHTML = ''; criticalBody.innerHTML = '';
        
        inventory.forEach((item, index) => {
            const isCritical = item.qty <= (item.limit || 5);
            if(item.warehouse === "Ankara") ankSum += item.qty; else istSum += item.qty;

            if(item.name.toLowerCase().includes(search) || 
               item.category.toLowerCase().includes(search) || 
               item.warehouse.toLowerCase().includes(search)) {
                body.innerHTML += `
                    <tr style="${isCritical ? 'background:rgba(239, 68, 68, 0.05)' : ''}">
                        <td>
                            <strong>${item.name}</strong><br>
                            <span class="tag tag-cat">${item.category}</span>
                            <small style="color:var(--secondary)">- ${item.supplier}</small>
                        </td>
                        <td><span class="tag tag-${item.warehouse.toLowerCase()}">${item.warehouse}</span></td>
                        <td><b style="color:${isCritical ? 'red':'inherit'}">${item.qty}</b> / <small>${item.limit || 5}</small></td>
                        <td style="text-align:right; white-space:nowrap;">
                            <input type="number" id="amt-${index}" value="1" style="width:40px; margin-right:5px">
                            <button class="btn-action" style="background:var(--success)" onclick="changeStock(${index}, 'add')">+</button>
                            <button class="btn-action" style="background:var(--danger)" onclick="changeStock(${index}, 'sub')">-</button>
                            <button class="btn-transfer" onclick="transferStock(${index})">‚áÑ</button>
                        </td>
                    </tr>`;
            }

            if(isCritical) {
                criticalCount++;
                criticalBody.innerHTML += `<tr><td>${item.name}</td><td><small>${item.warehouse}</small></td><td><span class="tag tag-danger">${item.qty}</span></td></tr>`;
            }
        });

        if(criticalCount === 0) criticalBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--success)">Stoklar yeterli.</td></tr>';

        logBody.innerHTML = '';
        [...logs].reverse().slice(0, 30).forEach(l => {
            logBody.innerHTML += `<tr><td>${l.time}</td><td>${l.name}</td><td>${l.wh}</td><td style="color:${l.type.includes('√áƒ±kƒ±≈ü')?'red':'green'}">${l.type}</td><td>${l.amount}</td><td><small>${l.info}</small></td></tr>`;
        });

        document.getElementById('ankaraTotal').innerText = ankSum;
        document.getElementById('istanbulTotal').innerText = istSum;
        document.getElementById('criticalAlert').innerText = criticalCount;

        localStorage.setItem('catDepoInv', JSON.stringify(inventory));
        localStorage.setItem('catDepoLogs', JSON.stringify(logs));
        myChart.data.datasets[0].data = [ankSum, istSum];
        myChart.update();
    }

    function changeStock(idx, type) {
        const amt = parseInt(document.getElementById(`amt-${idx}`).value || 1);
        const item = inventory[idx];
        if(type === 'sub') {
            if(item.qty < amt) return alert("Stok yetersiz!");
            let info = prompt("Hedef?");
            if(!info) return;
            item.qty -= amt;
            addLog(item.name, item.warehouse, '√áƒ±kƒ±≈ü', amt, info);
        } else {
            item.qty += amt;
            addLog(item.name, item.warehouse, 'Giri≈ü', amt, "Tedarik√ßi: " + item.supplier);
        }
        updateUI();
    }

    function transferStock(idx) {
        const item = inventory[idx];
        const targetWh = item.warehouse === "Ankara" ? "ƒ∞stanbul" : "Ankara";
        const amt = parseInt(document.getElementById(`amt-${idx}`).value || 1);
        if(item.qty < amt) return alert("Yetersiz stok!");
        if(!confirm(`${amt} adet √ºr√ºn ${item.warehouse} -> ${targetWh} transfer edilsin mi?`)) return;

        item.qty -= amt;
        let targetItem = inventory.find(i => i.name === item.name && i.warehouse === targetWh);
        if(targetItem) {
            targetItem.qty += amt;
        } else {
            inventory.push({name: item.name, category: item.category, warehouse: targetWh, supplier: item.supplier, qty: amt, limit: item.limit});
        }

        addLog(item.name, item.warehouse, 'Transfer (√áƒ±kƒ±≈ü)', amt, `${targetWh} Deposuna`);
        addLog(item.name, targetWh, 'Transfer (Giri≈ü)', amt, `${item.warehouse} Deposundan`);
        updateUI();
    }

    function addNewProduct() {
        const n = document.getElementById('newName').value, 
              c = document.getElementById('newCat').value,
              w = document.getElementById('newWarehouse').value,
              s = document.getElementById('newSupplier').value, 
              q = parseInt(document.getElementById('newQty').value),
              l = parseInt(document.getElementById('newLimit').value || 5);
        if(n && q >= 0) {
            inventory.push({name:n, category:c, warehouse:w, supplier:s, qty:q, limit:l});
            addLog(n, w, 'Giri≈ü', q, "ƒ∞lk Kayƒ±t");
            updateUI();
            document.getElementById('newName').value = '';
        }
    }

    function addLog(name, wh, type, amount, info) {
        logs.push({ time: new Date().toLocaleTimeString('tr-TR'), name, wh, type, amount, info });
    }

    function exportInventoryCSV() {
        let csv = 'Urun Adi,Kategori,Depo,Tedarikci,Stok,Limit\n';
        inventory.forEach(i => { csv += `${i.name},${i.category},${i.warehouse},${i.supplier},${i.qty},${i.limit}\n`; });
        downloadCSV(csv, 'stok_durumu.csv');
    }

    function exportLogsCSV() {
        let csv = 'Tarih,Urun,Depo,Islem,Miktar,Aciklama\n';
        logs.forEach(l => { csv += `${l.time},${l.name},${l.wh},${l.type},${l.amount},${l.info}\n`; });
        downloadCSV(csv, 'hareket_gecmisi.csv');
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", filename);
        link.click();
    }

    window.onload = () => { initChart(); updateUI(); };
</script>
</body>
</html>
