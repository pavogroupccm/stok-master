<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pavo Group | Tam Kapsamlƒ± ERP</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --secondary: #64748b; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9;
            --bg: #f8fafc; --card-bg: #ffffff; --text-main: #1e293b; --border: #e2e8f0; --input-bg: #f1f5f9; 
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
            --border: #334155; --input-bg: #334155; --secondary: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; }
        .login-logo { width: 180px; margin-bottom: 20px; filter: invert(0); }
        [data-theme="dark"] .login-logo { filter: invert(1); }
        .login-input { margin-bottom: 15px; padding: 12px; width: 100%; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; }

        /* LAYOUT */
        #app-screen { display: none; height: 100vh; width: 100%; }
        .wrapper { display: flex; height: 100%; width: 100%; }
        .sidebar { width: 260px; background: #1e293b; height: 100%; color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .brand-logo { width: 100%; max-width: 150px; margin-bottom: 20px; filter: brightness(0) invert(1); }
        
        .nav-group { margin-bottom: 15px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin-bottom: 5px; font-weight: bold; letter-spacing: 0.5px; }
        .nav-btn { width: 100%; background: transparent; color: #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 2px; cursor: pointer; border: none; text-align: left; font-weight: 500; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 0.9rem; }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn:hover:not(.active) { background: #334155; color: white; }

        .main-container { flex-grow: 1; overflow-y: auto; padding: 25px; position: relative; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* COMPONENTS */
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px; }
        input, select, textarea { background: var(--input-bg); color: var(--text-main); padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; color: var(--secondary); border-bottom: 2px solid var(--border); font-size: 0.75rem; }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-action { padding: 5px 8px; margin-left: 2px; border-radius: 4px; border: none; color: white; cursor: pointer; }
        
        .tag { padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .tag-ankara { background: #ffedd5; color: #9a3412; }
        .tag-istanbul { background: #e0f2fe; color: #075985; }
        .money { color: var(--success); font-weight: bold; }
        .fair-warning { background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); }

        /* FILTERS */
        .filter-group { display: flex; gap: 8px; margin: 10px 0 20px 0; }
        .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: var(--card-bg); color: var(--secondary); cursor: pointer; font-size: 0.75rem; font-weight: 600; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .expense-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); font-size: 0.9rem; }
        .detail-row.total { border-top: 2px solid var(--border); border-bottom: none; font-weight: bold; font-size: 1.1rem; margin-top: 10px; padding-top: 15px; color: var(--success); }

        /* ROBOT STYLES */
        .robot-results { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 350px; overflow-y: auto; margin-top: 15px; }
        .robot-item { padding: 12px; border: 1px solid var(--border); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); transition: 0.2s; }
        .robot-info h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--primary); }
        .robot-info p { margin: 0; font-size: 0.75rem; color: var(--secondary); }
        .robot-info a { color: var(--info); text-decoration: none; font-size: 0.75rem; }
    </style>
</head>
<body data-theme="light">

    <div id="login-screen">
        <div class="login-card">
            <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="login-logo">
            <h3>Kurumsal ERP</h3>
            <input type="email" id="email" class="login-input" placeholder="E-posta">
            <input type="password" id="password" class="login-input" placeholder="≈ûifre">
            <button class="btn btn-primary" style="width:100%" onclick="login()">Giri≈ü Yap</button>
            <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-screen">
        <div class="wrapper">
            <div class="sidebar">
                <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="brand-logo">
                
                <div class="nav-group">
                    <div class="nav-label">Genel</div>
                    <button class="nav-btn active" onclick="showPage('dashboard-page', this)">üìä Dashboard</button>
                    <button class="nav-btn" onclick="showPage('log-page', this)">üïí ƒ∞≈ülem Loglarƒ±</button>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Operasyon</div>
                    <button class="nav-btn" onclick="showPage('stok-page', this)">üì¶ Stok Y√∂netimi</button>
                    <button class="nav-btn" onclick="showPage('fuar-page', this)">üèüÔ∏è Fuar & Etkinlik</button>
                </div>

                <div class="nav-group">
                    <div class="nav-label">ƒ∞leti≈üim & PR</div>
                    <button class="nav-btn" onclick="showPage('media-page', this)">üë• Medya ƒ∞li≈ükileri</button>
                    <button class="nav-btn" onclick="showPage('press-page', this)">üì∞ Basƒ±n Yansƒ±malarƒ±</button>
                    <button class="nav-btn" onclick="showPage('content-page', this)">üìÖ ƒ∞√ßerik Takvimi</button>
                    <button class="nav-btn" onclick="showPage('supplier-page', this)">ü§ù Tedarik√ßi Havuzu</button>
                </div>
                
                <div style="margin-top:auto; padding-top:15px; border-top:1px solid #334155;">
                    <button class="nav-btn" onclick="toggleTheme()"><small>üåì Gece/G√ºnd√ºz</small></button>
                    <button class="nav-btn" onclick="logout()" style="color:var(--danger)"><small>üö™ √áƒ±kƒ±≈ü</small></button>
                </div>
            </div>

            <div class="main-container">

                <div id="dashboard-page" class="page active">
                    <h2 style="margin-bottom:20px">Y√∂netim √ñzeti</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><small>Toplam Stok Deƒüeri</small><h2 id="d-stock">0</h2></div>
                        <div class="stat-card"><small>Fuar B√ºt√ßesi</small><h2 id="d-fair" style="color:var(--success)">$0</h2></div>
                        <div class="stat-card"><small>Medya Veritabanƒ±</small><h2 id="d-media">0 Ki≈üi</h2></div>
                        <div class="stat-card"><small>Haber Yansƒ±masƒ±</small><h2 id="d-press">0 Adet</h2></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                        <div class="card"><h3>Stok Daƒüƒ±lƒ±mƒ±</h3><canvas id="chart1"></canvas></div>
                        <div class="card"><h3>ƒ∞leti≈üim Kanallarƒ±</h3><canvas id="chart2"></canvas></div>
                    </div>
                </div>

                <div id="stok-page" class="page">
                    <div class="card">
                        <h3>√úr√ºn Giri≈üi</h3>
                        <div class="form-grid">
                            <div>
                                <label>√úr√ºn Adƒ±</label><input type="text" id="pName">
                                <label style="margin-top:5px">Kategori</label><select id="pCat"><option>Genel</option><option>Basƒ±lƒ±</option><option>Promosyon</option><option>Demirba≈ü</option></select>
                            </div>
                            <div>
                                <label>Depo</label><select id="pWh"><option>Ankara</option><option>ƒ∞stanbul</option></select>
                                <div style="display:flex; gap:10px; margin-top:5px">
                                    <input type="number" id="pQty" placeholder="Adet" style="flex:1">
                                    <button class="btn btn-primary" onclick="addProduct()" style="flex:1">Ekle</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <input type="text" id="searchStock" onkeyup="updateStockUI()" placeholder="üîç √úr√ºn veya Kategori Ara..." style="margin-bottom:10px">
                        
                        <div class="filter-group">
                            <button class="filter-btn active" id="f-all" onclick="setWhFilter('all')">Hepsi</button>
                            <button class="filter-btn" id="f-Ankara" onclick="setWhFilter('Ankara')">Ankara</button>
                            <button class="filter-btn" id="f-ƒ∞stanbul" onclick="setWhFilter('ƒ∞stanbul')">ƒ∞stanbul</button>
                        </div>

                        <table>
                            <thead><tr><th>√úr√ºn</th><th>Depo</th><th>Stok</th><th style="text-align:right">ƒ∞≈ülemler (Adet Gir)</th></tr></thead>
                            <tbody id="stockBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="fuar-page" class="page">
                    <div class="card">
                        <h3>Yeni Fuar Planlama</h3>
                        <div class="form-grid">
                            <div>
                                <label>Fuar Adƒ±</label><input type="text" id="fName">
                                <label style="margin-top:5px">Tarih</label><input type="date" id="fDate">
                            </div>
                            <div>
                                 <label>√úlke</label><input type="text" id="fCountry">
                                 <div style="display:flex; gap:10px; margin-top:5px;">
                                     <input type="number" id="fRent" placeholder="Kira ($)" style="flex:1">
                                     <input type="number" id="fConst" placeholder="Stant ($)" style="flex:1">
                                 </div>
                                 <button class="btn btn-primary" onclick="addFair()" style="margin-top:10px; width:100%">Planla</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <table><thead><tr><th>Fuar</th><th>Tarih</th><th>Maliyet</th><th style="text-align:right">ƒ∞≈ülem</th></tr></thead><tbody id="fairBody"></tbody></table>
                    </div>
                </div>

                <div id="media-page" class="page">
                    <div class="card">
                        <h3>Yeni Gazeteci / Edit√∂r</h3>
                        <div class="form-grid">
                            <input type="text" id="mName" placeholder="Ad Soyad">
                            <input type="text" id="mOutlet" placeholder="Kurum">
                            <input type="text" id="mRole" placeholder="G√∂revi">
                            <input type="text" id="mEmail" placeholder="E-posta">
                            <input type="text" id="mPhone" placeholder="Telefon">
                            <button class="btn btn-primary" onclick="addMedia()">Kaydet</button>
                        </div>
                    </div>
                    <div class="card">
                        <table><thead><tr><th>ƒ∞sim / G√∂rev</th><th>Kurum</th><th>ƒ∞leti≈üim</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="mediaBody"></tbody></table>
                    </div>
                </div>

                <div id="press-page" class="page">
                    <div class="card" style="border-left: 5px solid var(--primary);">
                        <h3>ü§ñ Medya Robotu (Limitsiz)</h3>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="robotKeyword" value="Pavo Group" placeholder="Anahtar Kelime" style="flex:1">
                            <button class="btn btn-primary" onclick="fetchNews()">üîç Tara</button>
                        </div>
                        <div id="robotResults" class="robot-results"></div>
                    </div>
                    <div class="card">
                        <h3>Haber Ar≈üivi</h3>
                        <div class="form-grid">
                            <input type="text" id="prTitle" placeholder="Haber Ba≈ülƒ±ƒüƒ±">
                            <input type="text" id="prLink" placeholder="Link">
                            <button class="btn btn-primary" onclick="addPress()">Ekle</button>
                        </div>
                        <table><thead><tr><th>Tarih</th><th>Ba≈ülƒ±k</th><th>Link</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="pressBody"></tbody></table>
                    </div>
                </div>

                <div id="content-page" class="page">
                    <div class="card">
                        <h3>ƒ∞√ßerik Planla</h3>
                        <div class="form-grid">
                            <input type="date" id="cDate">
                            <select id="cPlatform"><option>LinkedIn</option><option>Twitter</option><option>Instagram</option></select>
                            <input type="text" id="cTitle" placeholder="Konu">
                            <select id="cStatus"><option>Taslak</option><option>Yayƒ±nda</option></select>
                            <button class="btn btn-primary" onclick="addContent()">Planla</button>
                        </div>
                    </div>
                    <div class="card">
                        <table><thead><tr><th>Tarih</th><th>Platform</th><th>ƒ∞√ßerik</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="contentBody"></tbody></table>
                    </div>
                </div>

                <div id="supplier-page" class="page">
                    <div class="card">
                        <h3>Tedarik√ßi Ekle</h3>
                        <div class="form-grid">
                            <input type="text" id="sName" placeholder="Firma Adƒ±">
                            <select id="sType"><option>Ajans</option><option>Matbaa</option><option>Lojistik</option></select>
                            <input type="text" id="sPhone" placeholder="ƒ∞leti≈üim">
                            <button class="btn btn-primary" onclick="addSupplier()">Ekle</button>
                        </div>
                    </div>
                    <div class="card">
                        <table><thead><tr><th>Firma</th><th>Hizmet</th><th>ƒ∞leti≈üim</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="supplierBody"></tbody></table>
                    </div>
                </div>

                <div id="log-page" class="page">
                    <div class="card">
                        <h3>ƒ∞≈ülem Loglarƒ±</h3>
                        <div style="max-height:500px;overflow-y:auto">
                            <table><thead><tr><th>Zaman</th><th>Kullanƒ±cƒ±</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="logBody"></tbody></table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="viewModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Fuar Kartƒ±</h3>
                <button onclick="closeModal('viewModal')" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úñ</button>
            </div>
            <div id="viewContent"></div>
            <div style="margin-top:15px; text-align:right;"><button class="btn" style="background:#ddd" onclick="closeModal('viewModal')">Kapat</button></div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>D√ºzenle & Gider Ekle</h3><button onclick="closeModal('editModal')" style="border:none;background:none;font-size:1.2rem;cursor:pointer">‚úñ</button></div>
            <input type="hidden" id="editId">
            <div class="form-grid">
                <div><label>Ad</label><input type="text" id="eName"><label>√úlke</label><input type="text" id="eCountry"><label>Tarih</label><input type="date" id="eDate"></div>
                <div><label>m¬≤</label><input type="number" id="eM2"><label>Kira ($)</label><input type="number" id="eRent"><label>Stant ($)</label><input type="number" id="eConst"><label>Tedarik√ßi</label><input type="text" id="eSupp"></div>
            </div>
            <h4 style="margin-top:15px; border-bottom:1px solid #eee">Ekstra Giderler</h4>
            <div id="expenseList"></div>
            <button class="btn btn-primary" onclick="addExpenseRow()" style="margin-top:10px; font-size:0.8rem">+ Gider Ekle</button>
            <button class="btn btn-primary" onclick="saveFairChanges()" style="margin-top:10px; width:100%">Kaydet</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAfvTWPkPVQ63T_fTHiYMRnerHkdgqbTr4",
      authDomain: "stokmasterbulut.firebaseapp.com",
      databaseURL: "https://stokmasterbulut-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "stokmasterbulut",
      storageBucket: "stokmasterbulut.firebasestorage.app",
      messagingSenderId: "623117556073",
      appId: "1:623117556073:web:b082fb0567879ac71d45f8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let stock=[], fairs=[], media=[], press=[], content=[], suppliers=[], logs=[];
    let whFilter = 'all';

    auth.onAuthStateChanged(user => {
        if(user){
            currentUser=user;
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-screen').style.display='block';
            initApp();
        } else {
            document.getElementById('login-screen').style.display='flex';
            document.getElementById('app-screen').style.display='none';
        }
    });

    function login(){
        const e=document.getElementById('email').value;
        const p=document.getElementById('password').value;
        auth.signInWithEmailAndPassword(e,p).catch(err=>alert("Giri≈ü ba≈üarƒ±sƒ±z!"));
    }
    function logout(){ auth.signOut(); }

    function initApp(){
        const refs = ['inventory','fairs','media','press','content','suppliers','logs'];
        refs.forEach(r => {
            db.ref(r).on('value', snap => {
                const val = snap.val();
                const list = val ? Object.values(val) : [];
                if(r==='inventory') { stock=list; updateStockUI(); }
                if(r==='fairs') { fairs=list; updateFairUI(); }
                if(r==='media') { media=list; updateMediaUI(); }
                if(r==='press') { press=list; updatePressUI(); }
                if(r==='content') { content=list; updateContentUI(); }
                if(r==='suppliers') { suppliers=list; updateSupplierUI(); }
                if(r==='logs') { logs=list; updateLogUI(); }
                updateDashboard();
            });
        });
    }

    // --- GOOGLE NEWS ---
    async function fetchNews() {
        const query = document.getElementById('robotKeyword').value;
        const container = document.getElementById('robotResults');
        if(!query) return alert("Anahtar kelime giriniz.");
        container.innerHTML = '<div style="padding:10px; text-align:center">Aranƒ±yor...</div>';
        try {
            const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=tr-TR&gl=TR&ceid=TR:tr`;
            const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
            const data = await response.json();
            container.innerHTML = '';
            if(!data.items || data.items.length === 0) { container.innerHTML = 'Haber bulunamadƒ±.'; return; }
            data.items.slice(0, 10).forEach(news => {
                const div = document.createElement('div'); div.className = 'robot-item';
                const date = new Date(news.pubDate).toLocaleDateString('tr-TR');
                div.innerHTML = `<div class="robot-info"><h4>${news.title}</h4><p>${news.author||'Google News'} - ${date}</p><a href="${news.link}" target="_blank">Git</a></div><button class="btn-action" style="background:var(--success)" onclick="saveRobotNews('${encodeURIComponent(news.title)}','Google News','${news.link}')">Ekle</button>`;
                container.appendChild(div);
            });
        } catch (error) { container.innerHTML = 'Hata olu≈ütu.'; }
    }
    function saveRobotNews(t, s, u) {
        db.ref('press/'+Date.now()).set({id:Date.now(), title:decodeURIComponent(t), outlet:s, date:new Date().toISOString().split('T')[0], sent:'N√∂tr', link:u});
        alert("Eklendi!");
    }

    // --- STOK (Fƒ∞LTRELƒ∞ & TRANSFERLƒ∞) ---
    function updateStockUI() {
        const s = document.getElementById('searchStock').value.toLowerCase();
        const b = document.getElementById('stockBody');
        b.innerHTML = '';
        stock.forEach(i => {
            const match = (i.name.toLowerCase().includes(s) || i.cat.toLowerCase().includes(s)) && (whFilter==='all' || i.wh===whFilter);
            if(match) {
                b.innerHTML += `<tr>
                    <td><b>${i.name}</b><br><small>${i.cat}</small></td>
                    <td><span class="tag tag-${i.wh.toLowerCase()}">${i.wh}</span></td>
                    <td><b>${i.qty}</b></td>
                    <td style="text-align:right">
                        <input type="number" id="amt-${i.id}" value="1" style="width:40px; text-align:center; padding:5px;">
                        <button class="btn-action" style="background:var(--success)" onclick="modStock('${i.id}',1)">+</button>
                        <button class="btn-action" style="background:var(--danger)" onclick="handleOut('${i.id}')">-</button>
                        <button class="btn-action" style="background:#8b5cf6" onclick="transfer('${i.id}')">‚áÑ</button>
                        <button class="btn-action" style="background:#64748b" onclick="del('inventory','${i.id}')">üóëÔ∏è</button>
                    </td></tr>`;
            }
        });
    }

    function modStock(id, dir) { 
        const i = stock.find(x => x.id===id); 
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        db.ref('inventory/'+id).update({qty: i.qty + (amt*dir)});
        log(dir>0 ? "Giri≈ü" : "√áƒ±kƒ±≈ü", i.name + " (" + amt + ")");
    }

    function handleOut(id) {
        const i = stock.find(x => x.id===id);
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        if(i.qty < amt) return alert("Yetersiz stok!");
        let dest = prompt("Nereye gidiyor? (√ñrn: Fuar, Personel)");
        if(!dest) return;
        db.ref('inventory/'+id).update({qty: i.qty - amt});
        log("√áƒ±kƒ±≈ü", `${i.name} (${amt}) -> ${dest}`);
    }

    function transfer(id) {
        const i = stock.find(x => x.id===id);
        const target = i.wh==="Ankara"?"ƒ∞stanbul":"Ankara";
        const amt = parseInt(document.getElementById('amt-'+id).value)||1;
        if(i.qty < amt) return alert("Yetersiz stok!");
        
        db.ref('inventory/'+id).update({qty: i.qty - amt});
        
        // Hedef depoda var mƒ±?
        const exist = stock.find(x => x.name===i.name && x.wh===target);
        if(exist) {
            db.ref('inventory/'+exist.id).update({qty: exist.qty + amt});
        } else {
            const nid = Date.now();
            db.ref('inventory/'+nid).set({...i, id:nid, wh:target, qty:amt});
        }
        log("Transfer", `${i.name} (${amt}) ${i.wh} -> ${target}`);
    }

    function setWhFilter(val) {
        whFilter = val;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('f-' + val).classList.add('active');
        updateStockUI();
    }

    // --- FUAR UI (DETAYLI) ---
    function updateFuarUI(){
        const b = document.getElementById('fairBody');
        const now = new Date(); const warn = new Date(); warn.setDate(now.getDate()+30);
        b.innerHTML = '';
        fairs.forEach(f=>{
            let tot = parseFloat(f.rent||0)+parseFloat(f.const||0);
            if(f.expenses) f.expenses.forEach(e=>tot+=parseFloat(e.cost||0));
            const d = new Date(f.date); const isSoon = d>=now && d<=warn;
            b.innerHTML += `<tr class="${isSoon?'fair-warning':''}">
                <td><b>${f.name}</b><br><small>${f.country}</small></td>
                <td>${f.date} ${isSoon?'‚ö†Ô∏è':''}</td>
                <td><span class="money">$ ${tot.toLocaleString()}</span></td>
                <td style="text-align:right">
                    <button class="btn-action" style="background:var(--info)" onclick="viewFair('${f.id}')">üëÅÔ∏è</button>
                    <button class="btn-action" style="background:#eab308" onclick="editFair('${f.id}')">‚úèÔ∏è</button>
                    <button class="btn-action" style="background:var(--danger)" onclick="del('fairs','${f.id}')">üóëÔ∏è</button>
                </td></tr>`;
        });
    }

    function viewFair(id){
        const f = fairs.find(x=>x.id==id);
        let exHtml = ''; let tot = parseFloat(f.rent||0)+parseFloat(f.const||0);
        if(f.expenses) f.expenses.forEach(e=>{ exHtml+=`<div class="detail-row"><span>${e.desc}</span><span>$ ${e.cost}</span></div>`; tot+=parseFloat(e.cost); });
        
        const html = `
            <h3 style="color:var(--primary)">${f.name}</h3>
            <div style="font-size:0.9rem; color:var(--secondary); margin-bottom:15px;">${f.country} - ${f.date}</div>
            <div class="detail-row"><span>Tedarik√ßi:</span><span>${f.supplier||'-'}</span></div>
            <div class="detail-row"><span>Alan:</span><span>${f.m2} m¬≤</span></div>
            <div style="margin-top:15px; font-weight:bold; border-bottom:1px solid #eee">Maliyetler</div>
            <div class="detail-row"><span>Kira:</span><span>$ ${parseFloat(f.rent||0).toLocaleString()}</span></div>
            <div class="detail-row"><span>Stant:</span><span>$ ${parseFloat(f.const||0).toLocaleString()}</span></div>
            ${exHtml}
            <div class="detail-row total"><span>TOPLAM:</span><span>$ ${tot.toLocaleString()}</span></div>
        `;
        document.getElementById('viewContent').innerHTML = html;
        document.getElementById('viewModal').style.display='flex';
    }

    function editFair(id){
        const f = fairs.find(x=>x.id==id);
        document.getElementById('editId').value=f.id;
        document.getElementById('eName').value=f.name; document.getElementById('eCountry').value=f.country;
        document.getElementById('eDate').value=f.date; document.getElementById('eM2').value=f.m2;
        document.getElementById('eRent').value=f.rent; document.getElementById('eConst').value=f.const;
        document.getElementById('eSupp').value=f.supplier;
        const c = document.getElementById('expenseList'); c.innerHTML='';
        if(f.expenses) f.expenses.forEach(e=>addExpenseRow(e.desc, e.cost));
        document.getElementById('editModal').style.display='flex';
    }

    function saveFairChanges(){
        const id=document.getElementById('editId').value;
        const ex=[]; document.querySelectorAll('.expense-row').forEach(r=>{
            const d=r.querySelector('.ex-desc').value; const c=r.querySelector('.ex-cost').value;
            if(d&&c) ex.push({desc:d, cost:c});
        });
        db.ref('fairs/'+id).update({
            name:document.getElementById('eName').value, country:document.getElementById('eCountry').value, date:document.getElementById('eDate').value,
            m2:document.getElementById('eM2').value, rent:document.getElementById('eRent').value, const:document.getElementById('eConst').value,
            supplier:document.getElementById('eSupp').value, expenses:ex
        });
        closeModal('editModal');
    }

    function addExpenseRow(d='', c=''){
        const div=document.createElement('div'); div.className='expense-row';
        div.innerHTML=`<input type="text" value="${d}" class="ex-desc" placeholder="Gider"><input type="number" value="${c}" class="ex-cost" placeholder="$" style="width:80px"><button onclick="this.parentElement.remove()" style="color:red;border:none;background:none;cursor:pointer">X</button>`;
        document.getElementById('expenseList').appendChild(div);
    }

    // --- OTHER UI & ACTIONS ---
    function updateDashboard(){
        document.getElementById('d-stock').innerText = stock.reduce((a,b)=>a+b.qty,0);
        let fairBud = fairs.reduce((a,b)=> {
            let sub = parseFloat(b.rent||0)+parseFloat(b.const||0);
            if(b.expenses) b.expenses.forEach(e=>sub+=parseFloat(e.cost||0));
            return a+sub;
        },0);
        document.getElementById('d-fair').innerText = "$ " + fairBud.toLocaleString();
        document.getElementById('d-media').innerText = media.length + " Ki≈üi";
        document.getElementById('d-press').innerText = press.length + " Adet";

        if(window.myChart1) window.myChart1.destroy();
        window.myChart1 = new Chart(document.getElementById('chart1'), {type:'doughnut',data:{labels:['Ankara','ƒ∞stanbul'],datasets:[{data:[stock.filter(i=>i.wh=='Ankara').length,stock.filter(i=>i.wh=='ƒ∞stanbul').length],backgroundColor:['#f97316','#0ea5e9']}]}});
        if(window.myChart2) window.myChart2.destroy();
        window.myChart2 = new Chart(document.getElementById('chart2'), {type:'bar',data:{labels:['Basƒ±n','LinkedIn','Twitter'],datasets:[{label:'Adet',data:[press.length,content.filter(c=>c.plat=='LinkedIn').length,content.filter(c=>c.plat=='Twitter/X').length],backgroundColor:'#6366f1'}]}});
    }

    function updateMediaUI(){ let h=''; media.forEach(m=>{ h+=`<tr><td><b>${m.name}</b><br><small>${m.role}</small></td><td>${m.outlet}</td><td><small>${m.email}</small></td><td><button class="btn-action" style="background:var(--danger)" onclick="del('media','${m.id}')">üóëÔ∏è</button></td></tr>`; }); document.getElementById('mediaBody').innerHTML=h; }
    function updatePressUI(){ let h=''; press.forEach(p=>{ let b=p.sent==='Pozitif'?'tag-pos':(p.sent==='Negatif'?'tag-neg':'tag-neu'); h+=`<tr><td><small>${p.date}</small></td><td><b>${p.title}</b><br><small>${p.outlet}</small></td><td><span class="tag ${b}">${p.sent}</span></td><td><a href="${p.link}" target="_blank">üîó</a></td><td><button class="btn-action" style="background:var(--danger)" onclick="del('press','${p.id}')">üóëÔ∏è</button></td></tr>`; }); document.getElementById('pressBody').innerHTML=h; }
    function updateContentUI(){ let h=''; content.forEach(c=>{ let k=c.status==='Yayƒ±nda'?'#22c55e':(c.status==='Taslak'?'#64748b':'#f59e0b'); h+=`<tr><td><small>${c.date}</small></td><td>${c.plat}</td><td>${c.title}</td><td><span style="color:${k};font-weight:bold">${c.status}</span></td><td><button class="btn-action" style="background:var(--danger)" onclick="del('content','${c.id}')">üóëÔ∏è</button></td></tr>`; }); document.getElementById('contentBody').innerHTML=h; }
    function updateSupplierUI(){ let h=''; suppliers.forEach(s=>{ h+=`<tr><td><b>${s.name}</b></td><td>${s.type}</td><td>${s.contact}<br><small>${s.phone}</small></td><td><button class="btn-action" style="background:var(--danger)" onclick="del('suppliers','${s.id}')">üóëÔ∏è</button></td></tr>`; }); document.getElementById('supplierBody').innerHTML=h; }
    function updateLogUI(){ let h=''; [...logs].reverse().forEach(l=>{ h+=`<tr><td><small>${l.time}</small></td><td><small>${l.user}</small></td><td>${l.action}</td></tr>`; }); document.getElementById('logBody').innerHTML=h; }

    function addProduct(){ const id=Date.now(); db.ref('inventory/'+id).set({id, name:v('pName'), cat:v('pCat'), wh:v('pWh'), qty:parseInt(v('pQty'))||0}); log("√úr√ºn Eklendi", v('pName')); clear(['pName','pQty']); }
    function addFair(){ const id=Date.now(); db.ref('fairs/'+id).set({id, name:v('fName'), country:v('fCountry'), date:v('fDate'), m2:v('fM2'), supplier:v('fSupp'), rent:v('fRent'), const:v('fConst')}); log("Fuar Eklendi", v('fName')); clear(['fName','fCountry','fM2','fSupp','fRent','fConst']); }
    function addMedia(){ const id=Date.now(); db.ref('media/'+id).set({id, name:v('mName'), outlet:v('mOutlet'), role:v('mRole'), email:v('mEmail'), phone:v('mPhone')}); log("Medya Eklendi", v('mName')); clear(['mName','mOutlet','mRole','mEmail','mPhone']); }
    function addPress(){ const id=Date.now(); db.ref('press/'+id).set({id, title:v('prTitle'), outlet:v('prOutlet'), date:v('prDate'), sent:v('prSentiment'), link:v('prLink')}); log("Haber Eklendi", v('prTitle')); clear(['prTitle','prOutlet','prLink']); }
    function addContent(){ const id=Date.now(); db.ref('content/'+id).set({id, date:v('cDate'), plat:v('cPlatform'), title:v('cTitle'), status:v('cStatus')}); log("ƒ∞√ßerik Planlandƒ±", v('cTitle')); clear(['cTitle']); }
    function addSupplier(){ const id=Date.now(); db.ref('suppliers/'+id).set({id, name:v('sName'), type:v('sType'), contact:v('sContact'), phone:v('sPhone')}); log("Tedarik√ßi Eklendi", v('sName')); clear(['sName','sContact','sPhone']); }

    function v(id){ return document.getElementById(id).value; }
    function clear(ids){ ids.forEach(id=>document.getElementById(id).value=''); }
    function del(path, id){ if(confirm('Silinsin mi?')) db.ref(path+'/'+id).remove(); log("Silme", path); }
    function log(act, det=''){ db.ref('logs/'+Date.now()).set({time:new Date().toLocaleString('tr-TR'), user:currentUser.email, action:act + (det ? ' - '+det : '')}); }
    
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function showPage(pid, btn){
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(pid).classList.add('active'); btn.classList.add('active');
    }
    function toggleTheme(){ const t=document.body.getAttribute('data-theme')=='dark'?'light':'dark'; document.body.setAttribute('data-theme',t); }
</script>
</body>
</html>
