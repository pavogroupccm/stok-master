<div id="stok-page" class="page">
    <div class="card">
        <h3>HÄ±zlÄ± ÃœrÃ¼n GiriÅŸi</h3>
        <div class="form-grid">
            <input type="text" id="pName" placeholder="ÃœrÃ¼n AdÄ±">
            <select id="pCat">
                <option>Promosyon</option>
                <option>BasÄ±lÄ±</option>
                <option>Sarf</option>
                <option>DemirbaÅŸ</option>
            </select>
            <select id="pWh">
                <option>Ankara</option>
                <option>Ä°stanbul</option>
            </select>
            <input type="number" id="pQty" placeholder="Adet">
            <button class="btn btn-primary" onclick="addProduct()">Kaydet</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
            <div style="display:flex; gap: 8px;">
                <button class="btn btn-sm filter-btn active" id="btn-all" onclick="setWhFilter('all')">ğŸŒ TÃ¼mÃ¼</button>
                <button class="btn btn-sm filter-btn" id="btn-ankara" onclick="setWhFilter('Ankara')">ğŸ“ Ankara</button>
                <button class="btn btn-sm filter-btn" id="btn-istanbul" onclick="setWhFilter('Ä°stanbul')">ğŸ“ Ä°stanbul</button>
            </div>
            <input type="text" id="searchStock" onkeyup="updateStockUI()" placeholder="ÃœrÃ¼n veya kategori ara..." style="max-width: 300px; margin-bottom: 0;">
        </div>

        <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
            <table style="margin-top:0">
                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                    <tr>
                        <th>ÃœrÃ¼n</th>
                        <th>Depo</th>
                        <th>Stok</th>
                        <th style="text-align:right">Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Mevcut script'ine eklemen veya gÃ¼ncellemen gereken fonksiyonlar:

    // 1. Filtreleme Fonksiyonu
    function setWhFilter(v) {
        whFilter = v;
        
        // ButonlarÄ±n aktiflik durumunu gÃ¶rsel olarak deÄŸiÅŸtir
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.style.background = '#e2e8f0';
            btn.style.color = '#333';
        });

        const activeBtn = v === 'all' ? 'btn-all' : (v === 'Ankara' ? 'btn-ankara' : 'btn-istanbul');
        const target = document.getElementById(activeBtn);
        target.style.background = 'var(--primary)';
        target.style.color = 'white';

        updateStockUI();
    }

    // 2. Stok ArayÃ¼zÃ¼ GÃ¼ncelleme (Filtreleme desteÄŸiyle)
    function updateStockUI() {
        const searchTxt = document.getElementById('searchStock').value.toLowerCase();
        const b = document.getElementById('stockBody');
        b.innerHTML = '';

        data.inventory.forEach(i => {
            const matchesSearch = i.name.toLowerCase().includes(searchTxt) || i.cat.toLowerCase().includes(searchTxt);
            const matchesWh = whFilter === 'all' || i.wh === whFilter;

            if (matchesSearch && matchesWh) {
                b.innerHTML += `
                <tr>
                    <td><b>${i.name}</b><br><small>${i.cat}</small></td>
                    <td><span class="tag tag-${i.wh}">${i.wh}</span></td>
                    <td><b style="font-size:1.1rem">${i.qty}</b></td>
                    <td style="text-align:right">
                        <div class="action-group">
                            <input type="number" id="q-${i.id}" value="1" style="width:50px; text-align:center; padding:6px; border:1px solid var(--border); border-radius:6px; margin-right:5px;">
                            <button class="btn-icon" style="background:var(--success)" onclick="modStock('${i.id}',1)">+</button>
                            <button class="btn-icon" style="background:var(--danger)" onclick="modStock('${i.id}',-1)">-</button>
                            <button class="btn-icon" style="background:var(--info)" onclick="transStock('${i.id}')">â‡„</button>
                            <button class="btn-icon" style="background:var(--secondary)" onclick="delItem('inventory', '${i.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>`;
            }
        });
    }

    // 3. Firebase'den veri Ã§ekme dinleyicisi (ID hatasÄ±nÄ± Ã¶nlemek iÃ§in)
    // Verileri Ã§ekerken firebaseId yerine senin oluÅŸturduÄŸun 'id'yi kullandÄ±ÄŸÄ±ndan emin ol
    function initListeners() {
        if(!db) return;
        const keys = ['inventory', 'fairs', 'media', 'press', 'competitors', 'brandAssets', 'content', 'suppliers', 'logs'];
        keys.forEach(k => {
            db.ref(k).on('value', s => {
                const val = s.val();
                // Objeyi array'e Ã§evirirken key'leri de saklayalÄ±m (silme iÅŸlemi iÃ§in lazÄ±m)
                data[k] = val ? Object.keys(val).map(key => ({...val[key], firebaseId: key})) : [];
                
                if(k==='inventory') { updateStockUI(); updateDashboard(); }
                // ... diÄŸerleri aynÄ± kalabilir
            });
        });
    }

    // 4. Silme fonksiyonunu Firebase'in benzersiz anahtarÄ±yla (firebaseId) Ã§alÄ±ÅŸacak ÅŸekilde gÃ¼ncelle
    function delItem(p, id) { 
        // Burada id parametresi aslÄ±nda i.id (Date.now) idi. 
        // EÄŸer veriyi silerken sorun yaÅŸÄ±yorsan db.ref(p).child(id).remove() yapmalÄ±sÄ±n.
        const item = data[p].find(x => x.id == id || x.firebaseId == id);
        const targetId = item.firebaseId || id;

        if(confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) { 
            db.ref(p).child(targetId).remove()
            .then(() => {
                showToast('Silindi','success'); 
                logAction('Silme', p);
            })
            .catch(err => showToast('Hata: ' + err.message, 'error'));
        } 
    }
</script>
