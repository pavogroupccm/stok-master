<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pavo Group | Enterprise ERP v2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #4f46e5; --primary-dark: #4338ca; --secondary: #64748b; 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9;
            --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #0f172a; --border: #e2e8f0; 
            --input-bg: #f8fafc; --sidebar-bg: #1e293b;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
            --border: #334155; --input-bg: #334155; --secondary: #94a3b8; --sidebar-bg: #020617;
        }
        
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; font-size: 14px; }

        /* --- TOAST NOTIFICATION (YENÄ°) --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast.success { border-left: 5px solid var(--success); }
        .toast.error { border-left: 5px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- LAYOUT --- */
        .wrapper { display: flex; height: 100%; width: 100%; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; transition: 0.3s; }
        .main-container { flex-grow: 1; overflow-y: auto; padding: 25px; position: relative; scroll-behavior: smooth; }
        
        .brand-logo { width: 100%; max-width: 160px; margin-bottom: 30px; filter: brightness(0) invert(1); display: block; margin-left: auto; margin-right: auto; }
        
        /* NAVIGATION */
        .nav-label { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 15px 0 5px 10px; font-weight: 700; letter-spacing: 0.5px; }
        .nav-btn { width: 100%; background: transparent; color: #cbd5e1; padding: 12px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; border: none; text-align: left; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 0.95rem; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* CARDS & GRIDS */
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .stat-card h2 { margin: 5px 0 0 0; font-size: 1.8rem; font-weight: 700; }
        .stat-card small { color: var(--secondary); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--secondary); margin-bottom: 6px; font-weight: 600; }
        input, select { background: var(--input-bg); color: var(--text-main); padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; width: 100%; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; color: var(--secondary); border-bottom: 2px solid var(--border); font-size: 0.8rem; text-transform: uppercase; font-weight: 600; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        /* BUTTONS */
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* ACTION BUTTONS (TABLE) */
        .action-group { display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; border: none; cursor: pointer; color: white; transition: 0.2s; }
        .btn-icon:hover { transform: translateY(-2px); opacity: 0.9; }

        /* BADGES */
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .tag-Ankara { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .tag-Ä°stanbul { background: #f0f9ff; color: #0369a1; border: 1px solid #e0f2fe; }
        .tag-pos { background: #dcfce7; color: #15803d; }
        .tag-neu { background: #f1f5f9; color: #475569; }
        .tag-neg { background: #fee2e2; color: #b91c1c; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 650px; border-radius: 16px; padding: 30px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .modal-header h3 { margin: 0; font-size: 1.25rem; }
        
        /* FILTERS */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--card-bg); color: var(--secondary); cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* UTILS */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        
        /* LOGIN */
        #login-screen { display: flex; height: 100vh; align-items: center; justify-content: center; background: var(--bg); position: fixed; width: 100%; z-index: 2000; }
    </style>
</head>
<body data-theme="light">

    <div id="toast-container"></div>

    <div id="login-screen">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center; padding: 40px;">
            <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="brand-logo" style="filter: invert(0); margin-bottom: 20px;">
            <h2 style="margin-bottom: 10px;">YÃ¶netim Paneli</h2>
            <p style="color: var(--secondary); margin-bottom: 30px;">LÃ¼tfen kurumsal hesabÄ±nÄ±zla giriÅŸ yapÄ±n.</p>
            
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary);">E-Posta</label>
                <input type="email" id="email" placeholder="ornek@pavo.com.tr">
            </div>
            <div style="text-align: left; margin-bottom: 25px;">
                <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary);">Åifre</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="login()">GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="wrapper">
            <div class="sidebar">
                <img src="https://www.pavo-group.com/wp-content/uploads/2024/sign/img/logo.png" class="brand-logo">
                
                <div class="nav-label">GENEL BAKIÅ</div>
                <button class="nav-btn active" onclick="showPage('dashboard-page', this)">ğŸ“Š YÃ¶netim Paneli</button>
                <button class="nav-btn" onclick="showPage('log-page', this)">ğŸ•’ Ä°ÅŸlem GÃ¼nlÃ¼ÄŸÃ¼</button>

                <div class="nav-label">OPERASYON</div>
                <button class="nav-btn" onclick="showPage('stok-page', this)">ğŸ“¦ Stok YÃ¶netimi</button>
                <button class="nav-btn" onclick="showPage('fuar-page', this)">ğŸŸï¸ Fuar Planlama</button>

                <div class="nav-label">Ä°LETÄ°ÅÄ°M & PR</div>
                <button class="nav-btn" onclick="showPage('media-page', this)">ğŸ‘¥ Medya CRM</button>
                <button class="nav-btn" onclick="showPage('press-page', this)">ğŸ“° BasÄ±n YansÄ±malarÄ±</button>
                <button class="nav-btn" onclick="showPage('content-page', this)">ğŸ“… Ä°Ã§erik Takvimi</button>
                <button class="nav-btn" onclick="showPage('supplier-page', this)">ğŸ¤ TedarikÃ§iler</button>

                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #334155;">
                    <div id="user-display" style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px;"></div>
                    <button class="nav-btn" onclick="toggleTheme()" style="font-size: 0.8rem;">ğŸŒ“ Tema DeÄŸiÅŸtir</button>
                    <button class="nav-btn" onclick="logout()" style="color: #f87171; font-size: 0.8rem;">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
            </div>

            <div class="main-container">
                
                <div id="dashboard-page" class="page active">
                    <h2 style="margin-bottom: 20px;">HoÅŸ Geldiniz ğŸ‘‹</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><small>Toplam Stok</small><h2 id="d-stock">0</h2></div>
                        <div class="stat-card"><small>Fuar BÃ¼tÃ§esi (YÄ±llÄ±k)</small><h2 id="d-fair" style="color:var(--success)">$0</h2></div>
                        <div class="stat-card"><small>Medya VeritabanÄ±</small><h2 id="d-media">0</h2></div>
                        <div class="stat-card"><small>Haber YansÄ±masÄ±</small><h2 id="d-press">0</h2></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="card">
                            <h3>Depo Doluluk OranÄ±</h3>
                            <div style="height: 250px;"><canvas id="chart1"></canvas></div>
                        </div>
                        <div class="card">
                            <h3>Ä°letiÅŸim PerformansÄ±</h3>
                            <div style="height: 250px;"><canvas id="chart2"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="stok-page" class="page">
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">HÄ±zlÄ± ÃœrÃ¼n GiriÅŸi</h3>
                        <div class="form-grid">
                            <div>
                                <div class="form-group"><label>ÃœrÃ¼n AdÄ±</label><input type="text" id="pName" placeholder="Ã–rn: Kalem Seti"></div>
                                <div class="form-group"><label>Kategori</label>
                                    <select id="pCat">
                                        <option value="Promosyon">Promosyon ÃœrÃ¼n</option>
                                        <option value="BasÄ±lÄ±">BasÄ±lÄ± Malzeme</option>
                                        <option value="Sarf">Sarf Malzeme</option>
                                        <option value="DemirbaÅŸ">DemirbaÅŸ</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="form-group"><label>Depo</label><select id="pWh"><option value="Ankara">Ankara Merkez</option><option value="Ä°stanbul">Ä°stanbul Ofis</option></select></div>
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <div class="form-group" style="flex:1"><label>Adet</label><input type="number" id="pQty" placeholder="0"></div>
                                    <button class="btn btn-primary" onclick="addProduct()" style="height: 42px; margin-bottom: 2px;">Kaydet</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="filter-bar">
                            <input type="text" id="searchStock" onkeyup="updateStockUI()" placeholder="ğŸ” ÃœrÃ¼n ara..." style="flex: 1; max-width: 300px;">
                            <div class="filter-group" style="margin:0;">
                                <button class="filter-btn active" id="f-all" onclick="setWhFilter('all')">TÃ¼mÃ¼</button>
                                <button class="filter-btn" id="f-Ankara" onclick="setWhFilter('Ankara')">Ankara</button>
                                <button class="filter-btn" id="f-Ä°stanbul" onclick="setWhFilter('Ä°stanbul')">Ä°stanbul</button>
                            </div>
                        </div>
                        <table>
                            <thead><tr><th>ÃœrÃ¼n DetayÄ±</th><th>Depo</th><th>Stok</th><th style="text-align:right">Ä°ÅŸlemler</th></tr></thead>
                            <tbody id="stockBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="fuar-page" class="page">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>Fuar Takvimi</h3>
                            <button class="btn btn-primary" onclick="openModal('fairModal')">+ Yeni Fuar Planla</button>
                        </div>
                        <table><thead><tr><th>Fuar AdÄ±</th><th>Tarih / Yer</th><th>Maliyet</th><th style="text-align:right">YÃ¶netim</th></tr></thead><tbody id="fairBody"></tbody></table>
                    </div>
                </div>

                <div id="media-page" class="page">
                    <div class="card">
                        <h3 style="margin-bottom:15px">Gazeteci Ekle</h3>
                        <div class="form-grid">
                            <input type="text" id="mName" placeholder="Ad Soyad"><input type="text" id="mOutlet" placeholder="Kurum">
                            <input type="text" id="mRole" placeholder="GÃ¶revi"><input type="text" id="mEmail" placeholder="E-posta">
                            <button class="btn btn-primary" onclick="addMedia()">Kaydet</button>
                        </div>
                    </div>
                    <div class="card"><table><thead><tr><th>Gazeteci</th><th>Kurum</th><th>Ä°letiÅŸim</th><th>Sil</th></tr></thead><tbody id="mediaBody"></tbody></table></div>
                </div>

                <div id="press-page" class="page">
                    <div class="card" style="border-left: 4px solid var(--info);">
                        <h3>ğŸ¤– Google News Robotu</h3>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="robotKeyword" value="Pavo Group" placeholder="Anahtar Kelime" style="flex:1">
                            <button class="btn btn-primary" onclick="fetchNews()">ğŸ” Tara ve Getir</button>
                        </div>
                        <div id="robotResults" class="robot-results"></div>
                    </div>
                    <div class="card">
                        <h3>BasÄ±n YansÄ±malarÄ± ArÅŸivi</h3>
                        <table><thead><tr><th>Tarih</th><th>BaÅŸlÄ±k</th><th>Link</th><th>Sil</th></tr></thead><tbody id="pressBody"></tbody></table>
                    </div>
                </div>

                <div id="content-page" class="page">
                    <div class="card">
                        <h3>Ä°Ã§erik Planla</h3>
                        <div class="form-grid">
                            <input type="date" id="cDate"><select id="cPlatform"><option>LinkedIn</option><option>Twitter</option><option>Instagram</option></select>
                            <input type="text" id="cTitle" placeholder="Konu"><button class="btn btn-primary" onclick="addContent()">Planla</button>
                        </div>
                    </div>
                    <div class="card"><table><thead><tr><th>Tarih</th><th>Platform</th><th>Konu</th><th>Durum</th><th>Sil</th></tr></thead><tbody id="contentBody"></tbody></table></div>
                </div>

                <div id="supplier-page" class="page">
                    <div class="card">
                        <h3>TedarikÃ§i Ekle</h3>
                        <div class="form-grid">
                            <input type="text" id="sName" placeholder="Firma AdÄ±"><select id="sType"><option>Ajans</option><option>Matbaa</option><option>Lojistik</option></select>
                            <input type="text" id="sContact" placeholder="Ä°letiÅŸim"><button class="btn btn-primary" onclick="addSupplier()">Ekle</button>
                        </div>
                    </div>
                    <div class="card"><table><thead><tr><th>Firma</th><th>TÃ¼r</th><th>Ä°letiÅŸim</th><th>Sil</th></tr></thead><tbody id="supplierBody"></tbody></table></div>
                </div>

                <div id="log-page" class="page">
                    <div class="card">
                        <h3>Sistem KayÄ±tlarÄ±</h3>
                        <div style="max-height:600px;overflow-y:auto"><table><thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="logBody"></tbody></table></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="fairModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Fuar Planlama</h3><button onclick="closeModal('fairModal')" class="btn-icon" style="color:var(--text-main)">âœ•</button></div>
            <input type="hidden" id="fEditId">
            
            <div class="form-grid">
                <div class="form-group"><label>Fuar AdÄ±</label><input type="text" id="fName"></div>
                <div class="form-group"><label>Ãœlke / Åehir</label><input type="text" id="fCountry"></div>
                <div class="form-group"><label>Tarih</label><input type="date" id="fDate"></div>
                <div class="form-group"><label>Alan (mÂ²)</label><input type="number" id="fM2"></div>
                <div class="form-group"><label>Kira Bedeli ($)</label><input type="number" id="fRent"></div>
                <div class="form-group"><label>Stant YapÄ±m ($)</label><input type="number" id="fConst"></div>
                <div class="form-group"><label>TedarikÃ§i</label><input type="text" id="fSupp"></div>
            </div>

            <div style="margin-top:15px; padding-top:15px; border-top:1px dashed var(--border);">
                <h4 style="margin:0 0 10px 0;">Ekstra Giderler</h4>
                <div id="expenseList"></div>
                <button class="btn btn-sm" style="background:#e2e8f0; color:#334155; margin-top:5px;" onclick="addExpenseRow()">+ Gider Kalemi Ekle</button>
            </div>

            <div style="margin-top:20px; text-align:right">
                <button class="btn btn-primary" onclick="saveFair()">Kaydet ve Kapat</button>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Fuar Detay KartÄ±</h3><button onclick="closeModal('viewModal')" class="btn-icon" style="color:var(--text-main)">âœ•</button></div>
            <div id="viewContent"></div>
            <div style="margin-top:20px; text-align:right"><button class="btn" style="background:var(--border); color:var(--text-main)" onclick="closeModal('viewModal')">Kapat</button></div>
        </div>
    </div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyAfvTWPkPVQ63T_fTHiYMRnerHkdgqbTr4",
      authDomain: "stokmasterbulut.firebaseapp.com",
      databaseURL: "https://stokmasterbulut-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "stokmasterbulut",
      storageBucket: "stokmasterbulut.firebasestorage.app",
      messagingSenderId: "623117556073",
      appId: "1:623117556073:web:b082fb0567879ac71d45f8"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error("Firebase init error", e); }
    
    const db = firebase.database();
    const auth = firebase.auth();

    // --- STATE ---
    let currentUser = null;
    let data = { inventory: [], fairs: [], media: [], press: [], content: [], suppliers: [], logs: [] };
    let whFilter = 'all';
    let charts = { stock: null, fair: null };

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('user-display').innerText = user.email;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            initListeners();
            showToast('GiriÅŸ baÅŸarÄ±lÄ±!', 'success');
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    function login() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        if(!e || !p) return showToast('LÃ¼tfen alanlarÄ± doldurun', 'error');
        auth.signInWithEmailAndPassword(e, p).catch(err => showToast('GiriÅŸ baÅŸarÄ±sÄ±z: ' + err.message, 'error'));
    }
    function logout() { auth.signOut(); }

    // --- DATA LISTENERS ---
    function initListeners() {
        const keys = Object.keys(data);
        keys.forEach(key => {
            db.ref(key).on('value', snap => {
                const val = snap.val();
                data[key] = val ? Object.values(val) : [];
                
                // Specific UI updates
                if(key === 'inventory') { updateStockUI(); updateDashboard(); }
                if(key === 'fairs') { updateFairUI(); updateDashboard(); }
                if(key === 'media') updateMediaUI();
                if(key === 'press') updatePressUI();
                if(key === 'content') updateContentUI();
                if(key === 'suppliers') updateSupplierUI();
                if(key === 'logs') updateLogUI();
            });
        });
    }

    // --- STOCK LOGIC (FIXED) ---
    function updateStockUI() {
        const term = document.getElementById('searchStock').value.toLowerCase();
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';

        data.inventory.forEach(item => {
            const matchesSearch = item.name.toLowerCase().includes(term) || item.cat.toLowerCase().includes(term);
            const matchesFilter = whFilter === 'all' || item.wh === whFilter;

            if (matchesSearch && matchesFilter) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600">${item.name}</div>
                        <div style="font-size:0.75rem; color:var(--secondary)">${item.cat}</div>
                    </td>
                    <td><span class="tag tag-${item.wh}">${item.wh}</span></td>
                    <td><span style="font-weight:bold; font-size:1.1rem; color:${item.qty < 10 ? 'var(--danger)':'inherit'}">${item.qty}</span></td>
                    <td style="text-align:right">
                        <div class="action-group">
                            <input type="number" id="qty-${item.id}" value="1" style="width:50px; text-align:center; padding:6px; border-radius:6px; border:1px solid var(--border)">
                            <button class="btn-icon" style="background:var(--success)" onclick="stockOp('${item.id}', 1)" title="Ekle">+</button>
                            <button class="btn-icon" style="background:var(--danger)" onclick="stockOp('${item.id}', -1)" title="Ã‡Ä±kar">-</button>
                            <button class="btn-icon" style="background:#8b5cf6" onclick="transferStock('${item.id}')" title="Transfer">â‡„</button>
                            <button class="btn-icon" style="background:#ef4444; margin-left:10px" onclick="deleteItem('inventory','${item.id}')" title="Sil">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function addProduct() {
        const name = document.getElementById('pName').value;
        const cat = document.getElementById('pCat').value;
        const wh = document.getElementById('pWh').value;
        const qty = parseInt(document.getElementById('pQty').value) || 0;

        if(!name) return showToast('ÃœrÃ¼n adÄ± gerekli', 'error');

        const id = Date.now().toString();
        db.ref('inventory/' + id).set({ id, name, cat, wh, qty })
          .then(() => { showToast('ÃœrÃ¼n eklendi', 'success'); clearInputs(['pName', 'pQty']); });
        logAction('ÃœrÃ¼n Ekleme', `${name} (${wh})`);
    }

    function stockOp(id, dir) {
        const item = data.inventory.find(i => i.id === id);
        const input = document.getElementById(`qty-${id}`);
        const val = parseInt(input.value) || 1;
        
        if(dir === -1 && item.qty < val) return showToast('Stok yetersiz!', 'error');

        const newQty = item.qty + (val * dir);
        db.ref(`inventory/${id}`).update({ qty: newQty });
        
        // EÄŸer Ã§Ä±kÄ±ÅŸ yapÄ±lÄ±yorsa ve bir yere gidiyorsa sorabiliriz, ama basit tutalÄ±m.
        logAction(dir === 1 ? 'Stok GiriÅŸ' : 'Stok Ã‡Ä±kÄ±ÅŸ', `${item.name} (${val} Adet)`);
        showToast('Stok gÃ¼ncellendi', 'success');
    }

    function transferStock(id) {
        const item = data.inventory.find(i => i.id === id);
        const input = document.getElementById(`qty-${id}`);
        const val = parseInt(input.value) || 1;
        const targetWh = item.wh === 'Ankara' ? 'Ä°stanbul' : 'Ankara';

        if(item.qty < val) return showToast('Transfer iÃ§in stok yetersiz', 'error');

        // 1. Kaynaktan DÃ¼ÅŸ
        db.ref(`inventory/${id}`).update({ qty: item.qty - val });

        // 2. Hedefte Var mÄ±?
        const targetItem = data.inventory.find(i => i.name === item.name && i.wh === targetWh);
        
        if(targetItem) {
            db.ref(`inventory/${targetItem.id}`).update({ qty: targetItem.qty + val });
        } else {
            const newId = Date.now().toString();
            db.ref(`inventory/${newId}`).set({
                id: newId, name: item.name, cat: item.cat, wh: targetWh, qty: val
            });
        }
        
        logAction('Transfer', `${item.name}: ${item.wh} -> ${targetWh} (${val})`);
        showToast('Transfer baÅŸarÄ±lÄ±', 'success');
    }

    function setWhFilter(val) {
        whFilter = val;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('f-' + val).classList.add('active');
        updateStockUI();
    }

    // --- FAIR LOGIC (Advanced) ---
    function updateFairUI() {
        const tbody = document.getElementById('fairBody');
        tbody.innerHTML = '';
        const now = new Date(); 
        const warningDate = new Date(); warningDate.setDate(now.getDate() + 30);

        data.fairs.forEach(f => {
            const fDate = new Date(f.date);
            const isNear = fDate >= now && fDate <= warningDate;
            
            // Calculate Total Cost
            let total = parseFloat(f.rent || 0) + parseFloat(f.const || 0);
            if(f.expenses) f.expenses.forEach(e => total += parseFloat(e.cost || 0));

            const tr = document.createElement('tr');
            if(isNear) tr.style.backgroundColor = '#fff7ed'; // Warning Color
            
            tr.innerHTML = `
                <td><strong>${f.name}</strong></td>
                <td>${f.date} <br> <span style="font-size:0.8rem; color:var(--secondary)">${f.country}</span> ${isNear ? 'âš ï¸' : ''}</td>
                <td><span class="money">$ ${total.toLocaleString()}</span></td>
                <td style="text-align:right">
                    <div class="action-group">
                        <button class="btn-icon" style="background:var(--info)" onclick="viewFair('${f.id}')">ğŸ‘ï¸</button>
                        <button class="btn-icon" style="background:var(--warning)" onclick="editFair('${f.id}')">âœï¸</button>
                        <button class="btn-icon" style="background:var(--danger)" onclick="deleteItem('fairs','${f.id}')">ğŸ—‘ï¸</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function saveFair() {
        const id = document.getElementById('fEditId').value || Date.now().toString();
        
        // Collect Expenses
        const expenses = [];
        document.querySelectorAll('.expense-row').forEach(row => {
            const desc = row.querySelector('.ex-desc').value;
            const cost = row.querySelector('.ex-cost').value;
            if(desc && cost) expenses.push({ desc, cost: parseFloat(cost) });
        });

        const fairData = {
            id,
            name: document.getElementById('fName').value,
            country: document.getElementById('fCountry').value,
            date: document.getElementById('fDate').value,
            m2: document.getElementById('fM2').value,
            rent: document.getElementById('fRent').value,
            const: document.getElementById('fConst').value,
            supplier: document.getElementById('fSupp').value,
            expenses: expenses
        };

        if(!fairData.name) return showToast('Fuar adÄ± giriniz', 'error');

        db.ref('fairs/' + id).update(fairData)
          .then(() => {
              showToast('Fuar kaydedildi', 'success');
              closeModal('fairModal');
              logAction('Fuar KayÄ±t', fairData.name);
          });
    }

    function editFair(id) {
        const f = data.fairs.find(i => i.id === id);
        if(!f) return;

        document.getElementById('fEditId').value = f.id;
        document.getElementById('fName').value = f.name;
        document.getElementById('fCountry').value = f.country;
        document.getElementById('fDate').value = f.date;
        document.getElementById('fM2').value = f.m2;
        document.getElementById('fRent').value = f.rent;
        document.getElementById('fConst').value = f.const;
        document.getElementById('fSupp').value = f.supplier;

        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        if(f.expenses) f.expenses.forEach(e => addExpenseRow(e.desc, e.cost));

        openModal('fairModal');
    }

    function viewFair(id) {
        const f = data.fairs.find(i => i.id === id);
        const rent = parseFloat(f.rent || 0);
        const constr = parseFloat(f.const || 0);
        let exTotal = 0;
        let exHtml = '';

        if(f.expenses) {
            f.expenses.forEach(e => {
                exTotal += parseFloat(e.cost);
                exHtml += `<div class="detail-row"><span>${e.desc}</span><span>$ ${parseFloat(e.cost).toLocaleString()}</span></div>`;
            });
        }

        const html = `
            <h2 style="color:var(--primary); margin-bottom:5px;">${f.name}</h2>
            <p style="color:var(--secondary); margin-bottom:20px;">ğŸ“ ${f.country} | ğŸ“… ${f.date}</p>
            
            <div style="background:var(--input-bg); padding:15px; border-radius:8px; margin-bottom:15px;">
                <div class="detail-row"><span>KatÄ±lÄ±m AlanÄ±</span><span>${f.m2} mÂ²</span></div>
                <div class="detail-row"><span>TedarikÃ§i</span><span>${f.supplier}</span></div>
            </div>

            <h4 style="border-bottom:1px solid var(--border); padding-bottom:5px;">Maliyet Tablosu</h4>
            <div class="detail-row"><span>Alan KirasÄ±</span><span>$ ${rent.toLocaleString()}</span></div>
            <div class="detail-row"><span>Stant YapÄ±m</span><span>$ ${constr.toLocaleString()}</span></div>
            ${exHtml}
            <div class="detail-row total"><span>GENEL TOPLAM</span><span>$ ${(rent+constr+exTotal).toLocaleString()}</span></div>
        `;
        
        document.getElementById('viewContent').innerHTML = html;
        openModal('viewModal');
    }

    function addExpenseRow(desc='', cost='') {
        const div = document.createElement('div');
        div.className = 'expense-row';
        div.innerHTML = `
            <input type="text" class="ex-desc" placeholder="Gider AÃ§Ä±klamasÄ±" value="${desc}" style="flex:2">
            <input type="number" class="ex-cost" placeholder="Tutar ($)" value="${cost}" style="flex:1">
            <button onclick="this.parentElement.remove()" style="background:var(--danger); color:white; border:none; border-radius:4px; width:30px; height:38px; cursor:pointer;">X</button>
        `;
        document.getElementById('expenseList').appendChild(div);
    }

    // --- MEDIA & CONTENT & SUPPLIER (Standard CRUD) ---
    function addMedia() {
        const obj = {
            id: Date.now().toString(),
            name: document.getElementById('mName').value,
            outlet: document.getElementById('mOutlet').value,
            role: document.getElementById('mRole').value,
            email: document.getElementById('mEmail').value
        };
        if(!obj.name) return;
        db.ref('media/' + obj.id).set(obj);
        showToast('Gazeteci eklendi', 'success'); clearInputs(['mName','mOutlet','mRole','mEmail']);
    }
    function updateMediaUI() {
        const b = document.getElementById('mediaBody'); b.innerHTML = '';
        data.media.forEach(m => {
            b.innerHTML += `<tr><td><b>${m.name}</b><br><small>${m.role}</small></td><td>${m.outlet}</td><td>${m.email}</td><td><button class="btn-icon" style="background:var(--danger)" onclick="deleteItem('media','${m.id}')">ğŸ—‘ï¸</button></td></tr>`;
        });
    }

    function addContent() {
        const obj = {
            id: Date.now().toString(),
            date: document.getElementById('cDate').value,
            plat: document.getElementById('cPlatform').value,
            title: document.getElementById('cTitle').value,
            status: 'Taslak'
        };
        if(!obj.title) return;
        db.ref('content/' + obj.id).set(obj);
        showToast('Ä°Ã§erik planlandÄ±', 'success'); clearInputs(['cTitle']);
    }
    function updateContentUI() {
        const b = document.getElementById('contentBody'); b.innerHTML = '';
        data.content.forEach(c => {
            b.innerHTML += `<tr><td>${c.date}</td><td>${c.plat}</td><td>${c.title}</td><td><span class="tag tag-neu">${c.status}</span></td><td><button class="btn-icon" style="background:var(--danger)" onclick="deleteItem('content','${c.id}')">ğŸ—‘ï¸</button></td></tr>`;
        });
    }

    function addSupplier() {
        const obj = {
            id: Date.now().toString(),
            name: document.getElementById('sName').value,
            type: document.getElementById('sType').value,
            contact: document.getElementById('sContact').value
        };
        if(!obj.name) return;
        db.ref('suppliers/' + obj.id).set(obj);
        showToast('TedarikÃ§i eklendi', 'success'); clearInputs(['sName','sContact']);
    }
    function updateSupplierUI() {
        const b = document.getElementById('supplierBody'); b.innerHTML = '';
        data.suppliers.forEach(s => {
            b.innerHTML += `<tr><td><b>${s.name}</b></td><td>${s.type}</td><td>${s.contact}</td><td><button class="btn-icon" style="background:var(--danger)" onclick="deleteItem('suppliers','${s.id}')">ğŸ—‘ï¸</button></td></tr>`;
        });
    }

    // --- GOOGLE NEWS ROBOT ---
    async function fetchNews() {
        const query = document.getElementById('robotKeyword').value;
        const container = document.getElementById('robotResults');
        if(!query) return showToast('Anahtar kelime girin', 'error');
        
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--secondary)">TaranÄ±yor...</div>';
        
        try {
            const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=tr-TR&gl=TR&ceid=TR:tr`;
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
            const json = await res.json();
            
            container.innerHTML = '';
            if(!json.items || json.items.length === 0) return container.innerHTML = '<div style="padding:10px">Haber bulunamadÄ±.</div>';

            json.items.slice(0,8).forEach(news => {
                const div = document.createElement('div');
                div.className = 'robot-item';
                div.innerHTML = `
                    <div class="robot-info">
                        <h4>${news.title}</h4>
                        <p>${new Date(news.pubDate).toLocaleDateString('tr-TR')} - ${news.author || 'Google News'}</p>
                        <a href="${news.link}" target="_blank">Haberi Oku â†—</a>
                    </div>
                    <button class="btn-icon" style="background:var(--success)" onclick="saveNews('${encodeURIComponent(news.title)}', '${news.link}')">+</button>
                `;
                container.appendChild(div);
            });
        } catch(e) {
            container.innerHTML = '<div style="color:var(--danger)">Hata oluÅŸtu.</div>';
        }
    }

    function saveNews(title, link) {
        db.ref('press/' + Date.now()).set({
            id: Date.now(),
            title: decodeURIComponent(title),
            link: link,
            date: new Date().toISOString().split('T')[0]
        });
        showToast('Haber arÅŸive eklendi', 'success');
    }
    function updatePressUI() {
        const b = document.getElementById('pressBody'); b.innerHTML = '';
        data.press.forEach(p => {
            b.innerHTML += `<tr><td>${p.date}</td><td>${p.title}</td><td><a href="${p.link}" target="_blank">Link</a></td><td><button class="btn-icon" style="background:var(--danger)" onclick="deleteItem('press','${p.id}')">ğŸ—‘ï¸</button></td></tr>`;
        });
    }

    // --- DASHBOARD & LOGS ---
    function updateDashboard() {
        // Counts
        document.getElementById('d-stock').innerText = data.inventory.reduce((a,b) => a+b.qty, 0);
        document.getElementById('d-media').innerText = data.media.length;
        document.getElementById('d-press').innerText = data.press.length;
        
        let totalBudget = 0;
        data.fairs.forEach(f => {
            totalBudget += parseFloat(f.rent||0) + parseFloat(f.const||0);
            if(f.expenses) f.expenses.forEach(e => totalBudget += parseFloat(e.cost||0));
        });
        document.getElementById('d-fair').innerText = "$ " + totalBudget.toLocaleString();

        // Charts
        const ctx1 = document.getElementById('chart1').getContext('2d');
        if(charts.stock) charts.stock.destroy();
        charts.stock = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Ankara', 'Ä°stanbul'],
                datasets: [{ 
                    data: [
                        data.inventory.filter(i=>i.wh==='Ankara').reduce((a,b)=>a+b.qty,0),
                        data.inventory.filter(i=>i.wh==='Ä°stanbul').reduce((a,b)=>a+b.qty,0)
                    ],
                    backgroundColor: ['#f97316', '#3b82f6']
                }]
            },
            options: { maintainAspectRatio: false }
        });

        const ctx2 = document.getElementById('chart2').getContext('2d');
        if(charts.fair) charts.fair.destroy();
        charts.fair = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Gazeteciler', 'Haberler', 'Planlanan Ä°Ã§erik'],
                datasets: [{
                    label: 'Adet',
                    data: [data.media.length, data.press.length, data.content.length],
                    backgroundColor: '#6366f1'
                }]
            },
            options: { maintainAspectRatio: false }
        });
    }

    function updateLogUI() {
        const b = document.getElementById('logBody'); b.innerHTML = '';
        [...data.logs].reverse().slice(0,50).forEach(l => {
            b.innerHTML += `<tr><td><small>${l.time}</small></td><td>${l.user}</td><td>${l.action}</td></tr>`;
        });
    }

    // --- UTILITIES ---
    function showPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
    }

    function openModal(id) { 
        // Reset Inputs if opening fresh
        if(id === 'fairModal') {
            if(!document.getElementById('fEditId').value) clearInputs(['fName','fCountry','fDate','fM2','fRent','fConst','fSupp']);
        }
        document.getElementById(id).style.display = 'flex'; 
    }
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        if(id === 'fairModal') document.getElementById('fEditId').value = ''; // Reset edit ID
    }

    function deleteItem(path, id) {
        if(confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) {
            db.ref(`${path}/${id}`).remove();
            showToast('KayÄ±t silindi', 'success');
            logAction('Silme', path);
        }
    }

    function logAction(action, detail) {
        db.ref('logs/' + Date.now()).set({
            time: new Date().toLocaleString('tr-TR'),
            user: currentUser.email,
            action: `${action} - ${detail}`
        });
    }

    function clearInputs(ids) { ids.forEach(id => document.getElementById(id).value = ''); }

    function showToast(msg, type='info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next);
    }
</script>
</body>
</html>
